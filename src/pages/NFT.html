<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionFocus Hours Â· å¹´åº¦NFTçºªå¿µ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script type="module" src="../js/utils/contract.js"></script>
    <style>
        :root {
            --primary-light: #FFF9F0;
            --primary-warm: #FFEEDD;
            --accent-pink: #FFB6C1;
            --accent-gold: #FFD700;
            --accent-purple: #DDA0DD;
            --text-brown: #8B4513;
            --text-dark: #5D4037;
            --shadow-soft: rgba(255, 182, 193, 0.2);
            --border-radius: 20px;
            --transition-slow: 0.8s ease;
            --transition-normal: 0.4s ease;
            --planet-1: #4ECDC4;
            --planet-2: #FF6B8B;
            --planet-3: #45B7D1;
            --planet-4: #96CEB4;
            --planet-5: #FFEAA7;
            --night-blue: #0A0A1A;
            --nft-glow: #9370DB;
            --nft-gold: #FFD700;
            --nft-silver: #C0C0C0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', 'ZCOOL XiaoWei', serif;
            background-color: var(--night-blue);
            color: #F0F0F0;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(106, 90, 205, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 107, 139, 0.1) 0%, transparent 40%);
        }

        /* å®‡å®™èƒŒæ™¯ */
        .universe-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* ä¸»å®¹å™¨ */
        .nft-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* å¤´éƒ¨ */
        .nft-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
            flex-wrap: wrap;
        }

        .logo {
            font-family: 'ZCOOL QingKe HuangYou', cursive;
            font-size: 2.5rem;
            color: var(--nft-glow);
            text-shadow: 0 0 10px rgba(147, 112, 219, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 2.2rem;
            color: var(--nft-glow);
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            text-align: right;
        }

        .current-year {
            font-size: 1.2rem;
            color: var(--nft-glow);
            font-weight: bold;
        }

        .progress-indicator {
            font-size: 0.95rem;
            color: #CCCCCC;
            background: rgba(20, 20, 40, 0.7);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(147, 112, 219, 0.2);
        }

        /* å¼•å¯¼åŒºåŸŸ */
        .guide-section {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 30px;
            position: relative;
            background: rgba(20, 20, 40, 0.4);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        .guide-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 30% 30%, rgba(147, 112, 219, 0.1) 0%, transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(255, 215, 0, 0.05) 0%, transparent 60%);
            z-index: 0;
            animation: pulse 8s infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 0.6; transform: scale(1.05); }
        }

        .guide-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem;
            color: var(--nft-glow);
            margin-bottom: 15px;
            text-shadow: 
                0 0 15px rgba(147, 112, 219, 0.7),
                0 0 30px rgba(147, 112, 219, 0.3);
            position: relative;
            z-index: 1;
        }

        .guide-subtitle {
            font-size: 1.8rem;
            color: #FFFFFF;
            margin-bottom: 15px;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .guide-text {
            font-size: 1.2rem;
            max-width: 900px;
            margin: 0 auto 20px;
            line-height: 1.6;
            color: #CCCCCC;
            position: relative;
            z-index: 1;
        }

        .highlight {
            color: var(--nft-gold);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        /* NFTå±•ç¤ºåŒº */
        .nft-display-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 40px 0;
            padding: 40px 20px;
            position: relative;
        }

        .nft-display-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            width: 100%;
            margin-bottom: 50px;
        }

        /* NFTå¡ç‰‡ */
        .nft-card {
            width: 400px;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 25px;
            border: 3px solid rgba(147, 112, 219, 0.3);
            padding: 30px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(147, 112, 219, 0.2);
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .nft-card::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(147, 112, 219, 0.3), 
                rgba(255, 215, 0, 0.3), 
                rgba(147, 112, 219, 0.3));
            border-radius: 27px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .nft-card:hover {
            transform: translateY(-10px);
            border-color: rgba(147, 112, 219, 0.6);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 50px rgba(147, 112, 219, 0.3);
        }

        .nft-card:hover::before {
            opacity: 1;
        }

        .nft-image-container {
            width: 100%;
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background-color: #1a1a2e;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .nft-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .nft-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
        }

        .nft-image-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--nft-glow);
        }

        .nft-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.2rem;
            color: var(--nft-gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .nft-description {
            font-size: 1.1rem;
            color: #CCCCCC;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }

        .nft-properties {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .nft-property {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .nft-property:hover {
            background: rgba(147, 112, 219, 0.1);
            border-color: rgba(147, 112, 219, 0.3);
            transform: translateY(-3px);
        }

        .property-label {
            font-size: 0.9rem;
            color: #AAAAAA;
            margin-bottom: 8px;
        }

        .property-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--nft-gold);
        }

        /* ç»Ÿè®¡æ•°æ® */
        .stats-card {
            width: 400px;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 25px;
            border: 3px solid rgba(78, 205, 196, 0.3);
            padding: 30px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.3),
                0 0 30px rgba(78, 205, 196, 0.2);
            transition: all 0.5s ease;
        }

        .stats-card:hover {
            transform: translateY(-10px);
            border-color: rgba(78, 205, 196, 0.6);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 50px rgba(78, 205, 196, 0.3);
        }

        .stats-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2rem;
            color: var(--planet-1);
            margin-bottom: 25px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-label-text {
            color: #CCCCCC;
            font-size: 1rem;
        }

        .stat-value {
            color: var(--planet-1);
            font-weight: bold;
            font-size: 1.3rem;
        }

        .stat-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .stat-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--planet-1), var(--planet-3));
            border-radius: 5px;
            transition: width 1s ease;
        }

        /* NFTé“¸é€ åŒºåŸŸ */
        .minting-section {
            width: 100%;
            max-width: 900px;
            margin: 40px auto;
            padding: 40px;
            background: rgba(20, 20, 40, 0.7);
            border-radius: 25px;
            border: 2px solid rgba(147, 112, 219, 0.2);
            text-align: center;
        }

        .minting-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--nft-glow);
            margin-bottom: 20px;
        }

        .minting-text {
            font-size: 1.2rem;
            color: #CCCCCC;
            margin-bottom: 30px;
            line-height: 1.6;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .minting-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 40px 0;
            position: relative;
        }

        .minting-steps::before {
            content: "";
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                rgba(147, 112, 219, 0.5), 
                rgba(78, 205, 196, 0.5), 
                rgba(255, 107, 139, 0.5));
            z-index: 0;
        }

        .minting-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            position: relative;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(20, 20, 40, 0.9);
            border: 3px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 15px;
            transition: all 0.5s;
        }

        .step-circle.completed {
            background: var(--planet-1);
            border-color: var(--planet-1);
            color: white;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
        }

        .step-circle.active {
            background: var(--nft-glow);
            border-color: var(--nft-glow);
            color: white;
            box-shadow: 0 0 25px rgba(147, 112, 219, 0.7);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 25px rgba(147, 112, 219, 0.7); }
            50% { box-shadow: 0 0 35px rgba(147, 112, 219, 0.9); }
            100% { box-shadow: 0 0 25px rgba(147, 112, 219, 0.7); }
        }

        .step-label {
            font-size: 1rem;
            color: #CCCCCC;
            text-align: center;
        }

        /* æŒ‰é’®æ ·å¼ */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .hand-drawn-btn {
            background-color: var(--accent-pink);
            color: var(--text-brown);
            border: 2px solid var(--text-brown);
            border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
            padding: 15px 30px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.4s;
            position: relative;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hand-drawn-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.3);
            background-color: #FFA7B3;
        }

        .hand-drawn-btn.primary {
            background-color: var(--nft-glow);
            color: white;
            border-color: var(--nft-glow);
            font-weight: bold;
        }

        .hand-drawn-btn.primary:hover {
            background-color: #8367C7;
            box-shadow: 0 5px 20px rgba(147, 112, 219, 0.4);
        }

        .hand-drawn-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .hand-drawn-btn:disabled:hover {
            transform: none;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
        }

        /* NFTè¯¦æƒ…å±•ç¤º */
        .nft-details {
            display: none;
            width: 100%;
            max-width: 900px;
            margin: 40px auto;
            padding: 40px;
            background: rgba(20, 20, 40, 0.9);
            border-radius: 25px;
            border: 3px solid var(--nft-glow);
            box-shadow: 0 0 50px rgba(147, 112, 219, 0.3);
            animation: fadeIn 1s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nft-details-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.5rem;
            color: var(--nft-gold);
            margin-bottom: 30px;
            text-align: center;
        }

        .nft-details-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .nft-details-image {
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .nft-details-image img {
            width: 100%;
            height: auto;
            display: block;
        }

        .nft-details-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .nft-details-item {
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .details-label {
            font-size: 1rem;
            color: #AAAAAA;
            margin-bottom: 8px;
        }

        .details-value {
            font-size: 1.3rem;
            color: white;
            word-break: break-all;
        }

        .contract-address {
            font-family: 'ZCOOL QingKe HuangYou', monospace;
            font-size: 1rem;
            color: var(--planet-1);
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
        }

        /* åº†ç¥åŠ¨ç”» */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--nft-glow);
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .nft-display-container {
                flex-direction: column;
                align-items: center;
            }
            
            .nft-card, .stats-card {
                width: 100%;
                max-width: 500px;
            }
        }

        @media (max-width: 900px) {
            .guide-title {
                font-size: 2.8rem;
            }
            
            .guide-subtitle {
                font-size: 1.5rem;
            }
            
            .minting-steps {
                flex-direction: column;
                gap: 40px;
            }
            
            .minting-steps::before {
                display: none;
            }
            
            .nft-details-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 2rem;
            }
            
            .guide-title {
                font-size: 2.2rem;
            }
            
            .nft-title {
                font-size: 1.8rem;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .hand-drawn-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }

        /* éšè—æ„¿æ™¯æ¿æ ·å¼ - ç”¨äºNFTé¢„è§ˆç”Ÿæˆ */
        #hiddenVisionBoardCanvas {
            font-family: 'Noto Serif SC', 'ZCOOL XiaoWei', serif;
        }

        .hidden-board-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .hidden-wish-item-container {
            position: absolute;
            z-index: 1;
        }

        .hidden-wish-item {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .hidden-wish-image {
            width: 100%;
            height: 70%;
            object-fit: cover;
            background-color: #f5f5f5;
            background-size: cover;
            background-position: center;
        }

        .hidden-wish-image.placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 2rem;
        }

        .hidden-wish-text {
            padding: 15px;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            text-align: center;
            font-size: 1.05rem;
            color: #5D4037;
            font-weight: 500;
            line-height: 1.3;
            overflow: hidden;
        }

        .hidden-focus-time {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            text-align: center;
            color: #5D4037;
            font-weight: bold;
            font-size: 1.1rem;
            z-index: 3;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
            padding: 5px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 0 0 12px 12px;
        }

        .hidden-wish-frame {
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 8px solid;
            border-image-slice: 8;
            border-image-width: 8px;
            border-image-repeat: stretch;
            pointer-events: none;
            z-index: 2;
        }

        .hidden-wish-frame.type-1 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23FFB6C1" stroke-width="5" rx="10"/></svg>');
        }

        .hidden-wish-frame.type-2 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23DDA0DD" stroke-width="5" rx="10" stroke-dasharray="10,5"/></svg>');
        }

        .hidden-wish-frame.type-3 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%234ECDC4" stroke-width="5" rx="10"/><circle cx="10" cy="10" r="3" fill="%234ECDC4"/><circle cx="90" cy="10" r="3" fill="%234ECDC4"/><circle cx="10" cy="90" r="3" fill="%234ECDC4"/><circle cx="90" cy="90" r="3" fill="%234ECDC4"/></svg>');
        }

        .hidden-wish-frame.type-4 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23FFD700" stroke-width="5" rx="10"/><path d="M10,10 L90,10 M90,10 L90,90 M90,90 L10,90 M10,90 L10,10" stroke="%23FFD700" stroke-width="2"/></svg>');
        }

        .hidden-milestone-effects {
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 20px;
            pointer-events: none;
            z-index: 1;
        }

        .hidden-milestone-10 .hidden-milestone-effects {
            background: radial-gradient(circle at 20% 30%, rgba(135, 206, 235, 0.3) 0%, transparent 50%),
                       radial-gradient(circle at 80% 70%, rgba(135, 206, 235, 0.3) 0%, transparent 50%);
            box-shadow: 0 0 10px rgba(135, 206, 235, 0.5);
        }

        .hidden-milestone-30 .hidden-milestone-effects {
            background: radial-gradient(circle at 20% 30%, rgba(152, 251, 152, 0.3) 0%, transparent 50%),
                       radial-gradient(circle at 80% 70%, rgba(152, 251, 152, 0.3) 0%, transparent 50%);
            box-shadow: 0 0 15px rgba(152, 251, 152, 0.5);
        }

        .hidden-milestone-60 .hidden-milestone-effects {
            background: conic-gradient(from 0deg, rgba(255, 215, 0, 0) 0%, rgba(255, 215, 0, 0.3) 25%, rgba(255, 215, 0, 0) 50%, rgba(255, 215, 0, 0.3) 75%, rgba(255, 215, 0, 0) 100%);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .hidden-milestone-100 .hidden-milestone-effects {
            background: linear-gradient(90deg, rgba(147, 112, 219, 0.3), rgba(255, 105, 180, 0.3), rgba(135, 206, 250, 0.3), rgba(152, 251, 152, 0.3), rgba(255, 215, 0, 0.3), rgba(147, 112, 219, 0.3));
            background-size: 400% 400%;
            box-shadow: 0 0 30px rgba(147, 112, 219, 0.5), 0 0 50px rgba(255, 105, 180, 0.3);
        }

        .hidden-sticker-element {
            position: absolute;
            z-index: 5;
            user-select: none;
            font-size: 50px;
        }
    </style>
</head>
<body>
    <!-- å®‡å®™èƒŒæ™¯ -->
    <div class="universe-bg" id="universeBg"></div>
    
    <!-- åº†ç¥åŠ¨ç”» -->
    <div class="celebration" id="celebration"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="nft-container">
        <!-- å¤´éƒ¨ -->
        <header class="nft-header">
            <div class="logo">
                <i class="fas fa-globe-americas logo-icon"></i>
                <span>VisionFocus Hours</span>
            </div>
            <div class="header-info">
                <div class="current-year" id="yearDisplay">2026å¹´åº¦NFTçºªå¿µ</div>
                <div class="progress-indicator">æ­¥éª¤ 5/5 Â· æ—¶å…‰å°å­˜</div>
            </div>
        </header>

        <!-- å¼•å¯¼åŒºåŸŸ -->
        <section class="guide-section">
            <div class="guide-bg"></div>
            <h1 class="guide-title">æ—¶å…‰å°å­˜ Â· å¹´åº¦NFTçºªå¿µ</h1>
            <h2 class="guide-subtitle">å°†ä¸€å¹´çš„ä¸“æ³¨æ—¶å…‰ï¼Œé“¸é€ æˆæ°¸æ’çš„æ•°å­—è®°å¿†</h2>
            <p class="guide-text">
                ä½ çš„<span class="highlight">2026æ„¿æ™¯æ¿</span>ä¸<span class="highlight">ä¸“æ³¨æ—¶å…‰æŠ•èµ„</span>å³å°†è¢«å°å­˜ä¸ºç‹¬ç‰¹çš„NFTã€‚<br>
                è¿™ä»½æ•°å­—çºªå¿µå“å°†æ°¸ä¹…è®°å½•ä½ åœ¨è¿™ä¸€å¹´çš„æˆé•¿è½¨è¿¹ä¸å®ç°å†ç¨‹ã€‚
            </p>
        </section>

        <!-- NFTå±•ç¤ºåŒº -->
        <section class="nft-display-section">
            <div class="nft-display-container">
                <!-- NFTå¡ç‰‡ -->
                <div class="nft-card">
                    <div class="nft-image-container" id="nftImageContainer">
                        <div class="nft-image-placeholder" id="nftPlaceholder">
                            <i class="fas fa-cube"></i>
                            <span>NFTé¢„è§ˆç”Ÿæˆä¸­...</span>
                        </div>
                        <img id="nftPreview" class="nft-image" style="display: none;" alt="NFTé¢„è§ˆ">
                    </div>
                    <h2 class="nft-title" id="nftName">VisionFocus Hours 2026</h2>
                    <p class="nft-description" id="nftDescription">
                        è®°å½•äº†2026å¹´çš„ä¸“æ³¨æ—¶å…‰ä¸æ„¿æ™¯å®ç°å†ç¨‹ã€‚åŒ…å«æ„¿æ™¯æ¿ã€æ—¶é—´æŠ•èµ„ç»Ÿè®¡ä¸é‡Œç¨‹ç¢‘æˆå°±ã€‚
                    </p>
                    
                    <div class="nft-properties">
                        <div class="nft-property">
                            <div class="property-label">å‘è¡Œå¹´ä»½</div>
                            <div class="property-value" id="nftYear">2026</div>
                        </div>
                        <div class="nft-property">
                            <div class="property-label">ç‰ˆæœ¬</div>
                            <div class="property-value">çºªå¿µç‰ˆ</div>
                        </div>
                        <div class="nft-property">
                            <div class="property-label">ç¨€æœ‰åº¦</div>
                            <div class="property-value" id="nftRarity">ç‹¬ç‰¹</div>
                        </div>
                        <div class="nft-property">
                            <div class="property-label">åŒºå—é“¾</div>
                            <div class="property-value">Sepolia</div>
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡æ•°æ®å¡ç‰‡ -->
                <div class="stats-card">
                    <h2 class="stats-title">å¹´åº¦æ—¶å…‰ç»Ÿè®¡</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="stat-label-text">æ€»ä¸“æ³¨æ—¶é—´</span>
                                <span class="stat-value" id="totalHoursStat">0</span>
                            </div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" id="totalHoursProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="stat-label-text">æ„¿æœ›ç¢ç‰‡</span>
                                <span class="stat-value" id="wishesStat">0/0</span>
                            </div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" id="wishesProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="stat-label-text">å®Œæˆé‡Œç¨‹ç¢‘</span>
                                <span class="stat-value" id="milestonesStat">0</span>
                            </div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" id="milestonesProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-label">
                                <span class="stat-label-text">å¹´åº¦æ´»è·ƒåº¦</span>
                                <span class="stat-value" id="activityStat">0%</span>
                            </div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" id="activityProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- NFTé“¸é€ åŒºåŸŸ -->
        <section class="minting-section">
            <h2 class="minting-title">é“¸é€ å¹´åº¦NFTçºªå¿µ</h2>
            <p class="minting-text">
                NFTå°†æ°¸ä¹…è®°å½•ä½ çš„å¹´åº¦æˆé•¿è½¨è¿¹ã€‚é“¸é€ è¿‡ç¨‹éœ€è¦å°‘é‡Gasè´¹ç”¨ï¼Œå®Œæˆåä½ å¯ä»¥<br>
                åœ¨åŒºå—é“¾ä¸Šæ°¸ä¹…æŸ¥çœ‹ã€åˆ†äº«æˆ–æ”¶è—è¿™ä»½ç‹¬ç‰¹çš„æ•°å­—è®°å¿†ã€‚
            </p>
            
            <div class="minting-steps">
                <div class="minting-step">
                    <div class="step-circle completed" id="step1">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">æ•°æ®å‡†å¤‡</div>
                </div>
                
                <div class="minting-step">
                    <div class="step-circle completed" id="step2">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-label">å›¾åƒç”Ÿæˆ</div>
                </div>
                
                <div class="minting-step">
                    <div class="step-circle active" id="step3">3</div>
                    <div class="step-label">ä¸Šé“¾é“¸é€ </div>
                </div>
                
                <div class="minting-step">
                    <div class="step-circle" id="step4">4</div>
                    <div class="step-label">å®Œæˆç¡®è®¤</div>
                </div>
            </div>
            
            <div class="control-buttons">
                <button class="hand-drawn-btn" id="previewBtn">
                    <i class="fas fa-eye"></i> é¢„è§ˆNFT
                </button>
                <button class="hand-drawn-btn primary" id="mintBtn">
                    <i class="fas fa-gem"></i> å¼€å§‹é“¸é€ NFT
                </button>
            </div>
            
            <p style="margin-top: 30px; color: #AAAAAA; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> 
                <span id="mintInfoText">é“¸é€ å°†åœ¨Sepoliaæµ‹è¯•ç½‘è¿›è¡Œï¼Œæ— éœ€çœŸå®è´¹ç”¨</span>
            </p>
        </section>

        <!-- NFTé“¸é€ è¯¦æƒ… -->
        <div class="nft-details" id="nftDetails">
            <h2 class="nft-details-title">ğŸ‰ NFTé“¸é€ æˆåŠŸï¼</h2>
            <div class="nft-details-content">
                <div class="nft-details-image">
                    <img id="finalNftImage" src="" alt="NFTå›¾åƒ">
                </div>
                
                <div class="nft-details-info">
                    <div class="nft-details-item">
                        <div class="details-label">NFTåç§°</div>
                        <div class="details-value" id="finalNftName">VisionFocus Hours 2026</div>
                    </div>
                    
                    <div class="nft-details-item">
                        <div class="details-label">Token ID</div>
                        <div class="details-value" id="tokenId">#20261231</div>
                    </div>
                    
                    <div class="nft-details-item">
                        <div class="details-label">æ™ºèƒ½åˆçº¦åœ°å€</div>
                        <div class="contract-address" id="contractAddress">
                            0x7b3a...f2c9
                        </div>
                    </div>
                    
                    <div class="nft-details-item">
                        <div class="details-label">é“¸é€ æ—¶é—´</div>
                        <div class="details-value" id="mintTime">2026-12-31 23:59:59</div>
                    </div>
                    
                    <div class="nft-details-item">
                        <div class="details-label">æŸ¥çœ‹é“¾æ¥</div>
                        <div class="details-value">
                            <a href="#" id="explorerLink" style="color: var(--planet-1);">åœ¨åŒºå—æµè§ˆå™¨æŸ¥çœ‹</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-buttons" style="margin-top: 40px;">
                <button class="hand-drawn-btn" id="shareBtn">
                    <i class="fas fa-share-alt"></i> åˆ†äº«æˆå°±
                </button>
                <button class="hand-drawn-btn primary" id="enterPlanetBtn">
                    <i class="fas fa-door-open"></i> è¿›å…¥æ˜Ÿçƒ
                </button>
                <button class="hand-drawn-btn" id="downloadBtn">
                    <i class="fas fa-download"></i> ä¸‹è½½NFTå›¾åƒ
                </button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ„¿æ™¯æ¿æ¸²æŸ“åŒºåŸŸï¼ˆç”¨äºç”ŸæˆNFTé¢„è§ˆï¼‰ -->
    <div id="hiddenVisionBoardContainer" style="position: absolute; left: -9999px; top: -9999px; width: 1200px; height: 800px; overflow: visible; z-index: -1;">
        <div id="hiddenVisionBoardCanvas" style="width: 1200px; height: 800px; position: relative; background-color: #FFF9F0; border-radius: 10px; overflow: visible;">
            <!-- èƒŒæ™¯å’Œå…ƒç´ å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // LocalStorageç®¡ç†
        const STORAGE_PREFIX = 'vfh_';
        
        function getStorageData(key) {
            try {
                const data = localStorage.getItem(STORAGE_PREFIX + key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Storage error:', e);
                return null;
            }
        }
        
        function setStorageData(key, value) {
            try {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Storage error:', e);
                return false;
            }
        }
        
        function getPlanet(year) {
            const planets = getStorageData('planets') || [];
            return planets.find(p => p.year === parseInt(year));
        }
        
        function updatePlanet(year, updates) {
            const planets = getStorageData('planets') || [];
            const index = planets.findIndex(p => p.year === parseInt(year));
            
            if (index !== -1) {
                planets[index] = { ...planets[index], ...updates };
                setStorageData('planets', planets);
                return planets[index];
            }
            return null;
        }
        
        // NFTæ•°æ®
        const nftData = {
            currentYear: new Date().getFullYear(),
            name: "VisionFocus Hours 2026",
            description: "è®°å½•äº†2026å¹´çš„ä¸“æ³¨æ—¶å…‰ä¸æ„¿æ™¯å®ç°å†ç¨‹ã€‚åŒ…å«æ„¿æ™¯æ¿ã€æ—¶é—´æŠ•èµ„ç»Ÿè®¡ä¸é‡Œç¨‹ç¢‘æˆå°±ã€‚",
            year: "2026",
            rarity: "ç‹¬ç‰¹",
            totalHours: 0,
            totalWishes: 0,
            completedWishes: 0,
            milestones: 0,
            activity: 0,
            minted: false,
            tokenId: null,
            contractAddress: null,
            mintTime: null,
            imageUrl: null,
            currentStep: 3,
            
            // æ¨¡æ‹Ÿæ•°æ®
            sampleData: {
                totalHours: 187,
                totalWishes: 8,
                completedWishes: 3,
                milestones: 2,
                activity: 68
            }
        };

        // DOMå…ƒç´ 
        const universeBg = document.getElementById('universeBg');
        const celebration = document.getElementById('celebration');
        const nftImageContainer = document.getElementById('nftImageContainer');
        const nftPlaceholder = document.getElementById('nftPlaceholder');
        const nftPreview = document.getElementById('nftPreview');
        const nftName = document.getElementById('nftName');
        const nftDescription = document.getElementById('nftDescription');
        const nftYear = document.getElementById('nftYear');
        const nftRarity = document.getElementById('nftRarity');
        
        // ç»Ÿè®¡å…ƒç´ 
        const totalHoursStat = document.getElementById('totalHoursStat');
        const totalHoursProgress = document.getElementById('totalHoursProgress');
        const wishesStat = document.getElementById('wishesStat');
        const wishesProgress = document.getElementById('wishesProgress');
        const milestonesStat = document.getElementById('milestonesStat');
        const milestonesProgress = document.getElementById('milestonesProgress');
        const activityStat = document.getElementById('activityStat');
        const activityProgress = document.getElementById('activityProgress');
        
        // æ­¥éª¤å…ƒç´ 
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        
        // æŒ‰é’®
        const previewBtn = document.getElementById('previewBtn');
        const mintBtn = document.getElementById('mintBtn');
        const nftDetails = document.getElementById('nftDetails');
        const finalNftName = document.getElementById('finalNftName');
        const tokenId = document.getElementById('tokenId');
        const contractAddress = document.getElementById('contractAddress');
        const mintTime = document.getElementById('mintTime');
        const explorerLink = document.getElementById('explorerLink');
        const shareBtn = document.getElementById('shareBtn');
        const enterPlanetBtn = document.getElementById('enterPlanetBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
            createStarBackground();
            loadUserData();
            // å»¶è¿Ÿç”Ÿæˆé¢„è§ˆï¼Œç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ
            setTimeout(() => {
                generateNFTPreview();
            }, 500);
        });

        async function initApp() {
            // ä»URLè·å–å¹´ä»½å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            nftData.currentYear = parseInt(urlParams.get('year')) || new Date().getFullYear();
            nftData.year = nftData.currentYear.toString();
            nftData.name = `VisionFocus Hours ${nftData.currentYear}`;
            
            // æ›´æ–°UI
            document.getElementById('yearDisplay').textContent = `${nftData.currentYear}å¹´åº¦NFTçºªå¿µ`;
            nftName.textContent = nftData.name;
            nftYear.textContent = nftData.year;
            
            // æ£€æŸ¥åˆçº¦é…ç½®çŠ¶æ€
            try {
                if (typeof contractService !== 'undefined') {
                    const contract = window.contractService || contractService;
                    await contract.init('sepolia');
                    if (contract.isSimulateMode && contract.isSimulateMode()) {
                        const mintInfoText = document.getElementById('mintInfoText');
                        if (mintInfoText) {
                            mintInfoText.innerHTML = '<span style="color: #FFD700;">âš ï¸ æ¨¡æ‹Ÿæ¨¡å¼ï¼šåˆçº¦æœªéƒ¨ç½²ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿé“¸é€ ã€‚è¯·éƒ¨ç½²åˆçº¦åæ›´æ–°åˆçº¦åœ°å€ã€‚</span>';
                        }
                    }
                }
            } catch (e) {
                console.log('åˆçº¦æ£€æŸ¥:', e.message);
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰æ•°æ®
            const hasData = checkForUserData();
            
            if (!hasData) {
                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæç¤ºç”¨æˆ·å¹¶è·³è½¬
                showNotification('è¯·å…ˆå®Œæˆæ„¿æ™¯æ¿å’Œä¸“æ³¨æ—¶å…‰æŠ•èµ„', 'info');
                setTimeout(() => {
                    window.location.href = `visionboard.html?year=${nftData.currentYear}`;
                }, 2000);
                return;
            }
            
            updateStatsDisplay();
        }

        function createStarBackground() {
            const starCount = 200;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // éšæœºä½ç½®
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // éšæœºå¤§å°
                const size = Math.random() * 3 + 1;
                
                // éšæœºé—ªçƒå»¶è¿Ÿ
                const delay = Math.random() * 3;
                
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${delay}s`;
                
                universeBg.appendChild(star);
            }
        }

        function checkForUserData() {
            try {
                // ä»LocalStorageåŠ è½½å¯¹åº”å¹´ä»½çš„æ•°æ®
                const focusDataKey = `focus_${nftData.currentYear}`;
                const boardStateKey = `visionboard_${nftData.currentYear}`;
                
                const focusData = getStorageData(focusDataKey);
                const visionBoardData = getStorageData(boardStateKey);
                
                if (focusData && visionBoardData && visionBoardData.wishes && visionBoardData.wishes.length > 0) {
                    // åˆå¹¶æ•°æ®ï¼šæ„¿æ™¯æ¿æ•°æ®ä¸­çš„æ„¿æœ›å¯èƒ½å·²ç»åŒ…å«ä¸“æ³¨æ—¶é—´
                    const wishes = visionBoardData.wishes.map(wish => {
                        // æŸ¥æ‰¾ä¸“æ³¨æ•°æ®ä¸­å¯¹åº”çš„æ„¿æœ›
                        const focusWish = focusData.wishes?.find(fw => fw.id === wish.id);
                        return {
                            ...wish,
                            focusHours: focusWish?.focusHours || wish.focusHours || 0
                        };
                    });
                    
                    // è®¡ç®—ç»Ÿè®¡æ•°æ®
                    nftData.totalHours = focusData.totalHours || wishes.reduce((sum, w) => sum + (w.focusHours || 0), 0);
                    nftData.totalWishes = wishes.length;
                    
                    // è®¡ç®—å®Œæˆçš„æ„¿æœ›ï¼ˆå‡è®¾100å°æ—¶ä¸ºå®Œæˆï¼‰
                    nftData.completedWishes = wishes.filter(w => w.focusHours >= 100).length;
                    
                    // è®¡ç®—é‡Œç¨‹ç¢‘æ•°é‡ï¼ˆæ¯ä¸ªæ„¿æœ›æœ€å¤š4ä¸ªé‡Œç¨‹ç¢‘ï¼š10, 30, 60, 100ï¼‰
                    nftData.milestones = wishes.reduce((count, w) => {
                        const hours = w.focusHours || 0;
                        if (hours >= 100) return count + 4;
                        if (hours >= 60) return count + 3;
                        if (hours >= 30) return count + 2;
                        if (hours >= 10) return count + 1;
                        return count;
                    }, 0);
                    
                    // è®¡ç®—æ´»è·ƒåº¦ï¼ˆåŸºäºæ€»å°æ—¶æ•°ï¼Œå‡è®¾500å°æ—¶ä¸º100%ï¼‰
                    nftData.activity = Math.min(100, Math.floor((nftData.totalHours / 500) * 100));
                    
                    return true;
                }
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
            }
            
            return false;
        }

        function updateStatsDisplay() {
            // æ›´æ–°æ€»æ—¶é—´
            totalHoursStat.textContent = nftData.totalHours;
            totalHoursProgress.style.width = `${Math.min(100, nftData.totalHours / 2)}%`;
            
            // æ›´æ–°æ„¿æœ›ç»Ÿè®¡
            wishesStat.textContent = `${nftData.completedWishes}/${nftData.totalWishes}`;
            const wishesPercent = nftData.totalWishes > 0 ? 
                (nftData.completedWishes / nftData.totalWishes) * 100 : 0;
            wishesProgress.style.width = `${wishesPercent}%`;
            
            // æ›´æ–°é‡Œç¨‹ç¢‘ç»Ÿè®¡
            const maxMilestones = nftData.totalWishes * 4; // æ¯ä¸ªæ„¿æœ›æœ€å¤š4ä¸ªé‡Œç¨‹ç¢‘
            const milestonesPercent = maxMilestones > 0 ? 
                (nftData.milestones / maxMilestones) * 100 : 0;
            milestonesStat.textContent = nftData.milestones;
            milestonesProgress.style.width = `${milestonesPercent}%`;
            
            // æ›´æ–°æ´»è·ƒåº¦
            activityStat.textContent = `${nftData.activity}%`;
            activityProgress.style.width = `${nftData.activity}%`;
            
            // æ›´æ–°ç¨€æœ‰åº¦
            if (nftData.totalHours >= 200) {
                nftRarity.textContent = "ä¼ å¥‡";
                nftRarity.style.color = "var(--nft-gold)";
            } else if (nftData.totalHours >= 100) {
                nftRarity.textContent = "ç¨€æœ‰";
                nftRarity.style.color = "var(--accent-purple)";
            } else {
                nftRarity.textContent = "ç‹¬ç‰¹";
                nftRarity.style.color = "var(--planet-1)";
            }
        }

        function generateNFTPreview() {
            // ç”ŸæˆNFTé¢„è§ˆå›¾åƒï¼ˆä»æ„¿æ™¯æ¿æ•è·ï¼‰
            nftPlaceholder.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ç”ŸæˆNFTé¢„è§ˆ...';
            
            // æ£€æŸ¥html2canvasæ˜¯å¦å·²åŠ è½½
            if (typeof html2canvas === 'undefined') {
                showNotification('å›¾ç‰‡ç”Ÿæˆåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                nftPlaceholder.innerHTML = '<i class="fas fa-exclamation-circle"></i> ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
                return;
            }
            
            // æ¸²æŸ“éšè—çš„æ„¿æ™¯æ¿
            renderHiddenVisionBoard().then(() => {
                // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
                waitForImagesToLoad().then(() => {
                    // ä½¿ç”¨html2canvasæ•è·æ„¿æ™¯æ¿
                    captureVisionBoardAsImage();
                });
            });
        }
        
        function renderHiddenVisionBoard() {
            return new Promise((resolve) => {
                try {
                    // è·å–æ•°æ®
                    const boardStateKey = `visionboard_${nftData.currentYear}`;
                    const focusDataKey = `focus_${nftData.currentYear}`;
                    
                    const boardState = getStorageData(boardStateKey);
                    const focusData = getStorageData(focusDataKey);
                    
                    if (!boardState || !boardState.wishes || boardState.wishes.length === 0) {
                        showNotification('æœªæ‰¾åˆ°æ„¿æ™¯æ¿æ•°æ®', 'error');
                        resolve();
                        return;
                    }
                    
                    const hiddenCanvas = document.getElementById('hiddenVisionBoardCanvas');
                    hiddenCanvas.innerHTML = '';
                    
                    // è®¾ç½®èƒŒæ™¯
                    const bgDiv = document.createElement('div');
                    bgDiv.className = 'hidden-board-background';
                    updateHiddenBackground(bgDiv, boardState.backgroundType || '1');
                    hiddenCanvas.appendChild(bgDiv);
                    
                    // åˆå¹¶æ„¿æœ›æ•°æ®å’Œä¸“æ³¨æ—¶é—´æ•°æ®
                    const wishes = boardState.wishes.map(wish => {
                        const focusWish = focusData?.wishes?.find(fw => fw.id === wish.id);
                        return {
                            ...wish,
                            focusHours: focusWish?.focusHours || wish.focusHours || 0
                        };
                    });
                    
                    // æ¸²æŸ“æ¯ä¸ªæ„¿æœ›ç¢ç‰‡
                    wishes.forEach(wish => {
                        createHiddenWishItem(hiddenCanvas, wish);
                    });
                    
                    // æ¸²æŸ“è´´çº¸
                    if (boardState.stickers && boardState.stickers.length > 0) {
                        boardState.stickers.forEach(stickerData => {
                            const sticker = document.createElement('div');
                            sticker.className = 'hidden-sticker-element';
                            sticker.innerHTML = `<div style="text-align: center;">${stickerData.content}</div>`;
                            
                            sticker.style.left = `${stickerData.position.x}px`;
                            sticker.style.top = `${stickerData.position.y}px`;
                            sticker.style.width = `${stickerData.size.width}px`;
                            sticker.style.height = `${stickerData.size.height}px`;
                            sticker.style.fontSize = `${stickerData.size.height * 0.8}px`;
                            
                            hiddenCanvas.appendChild(sticker);
                        });
                    }
                    
                    resolve();
                } catch (e) {
                    console.error('æ¸²æŸ“éšè—æ„¿æ™¯æ¿å¤±è´¥:', e);
                    resolve();
                }
            });
        }
        
        function createHiddenWishItem(canvas, wish) {
            // åˆ›å»ºå®¹å™¨
            const container = document.createElement('div');
            container.className = 'hidden-wish-item-container';
            
            // åº”ç”¨é‡Œç¨‹ç¢‘ç±»
            const hours = wish.focusHours || 0;
            if (hours >= 100) {
                container.classList.add('hidden-milestone-100');
            } else if (hours >= 60) {
                container.classList.add('hidden-milestone-60');
            } else if (hours >= 30) {
                container.classList.add('hidden-milestone-30');
            } else if (hours >= 10) {
                container.classList.add('hidden-milestone-10');
            }
            
            container.style.left = `${wish.position.x}px`;
            container.style.top = `${wish.position.y}px`;
            container.style.width = `${wish.size.width}px`;
            container.style.height = `${wish.size.height}px`;
            container.style.transform = `rotate(${wish.rotation}deg)`;
            container.style.zIndex = wish.zIndex || 1;
            
            // åˆ›å»ºæ„¿æœ›é¡¹ç›®
            const wishItem = document.createElement('div');
            wishItem.className = 'hidden-wish-item';
            
            // å›¾ç‰‡åŒºåŸŸ
            const imageDiv = document.createElement('div');
            imageDiv.className = 'hidden-wish-image';
            
            if (wish.image) {
                imageDiv.style.backgroundImage = `url(${wish.image})`;
                imageDiv.style.backgroundSize = 'cover';
                imageDiv.style.backgroundPosition = 'center';
            } else {
                imageDiv.classList.add('placeholder');
                imageDiv.innerHTML = `<i class="fas fa-image"></i>`;
            }
            
            // æ–‡å­—åŒºåŸŸ
            const textDiv = document.createElement('div');
            textDiv.className = 'hidden-wish-text';
            textDiv.textContent = wish.text || 'æ„¿æœ›ç¢ç‰‡';
            
            // ä¸“æ³¨æ—¶é—´æ˜¾ç¤º
            const timeDiv = document.createElement('div');
            timeDiv.className = 'hidden-focus-time';
            timeDiv.textContent = `${hours}å°æ—¶`;
            
            // ç›¸æ¡†
            const frameDiv = document.createElement('div');
            frameDiv.className = `hidden-wish-frame type-${wish.frameType || '1'}`;
            
            // é‡Œç¨‹ç¢‘åŠ¨æ•ˆå±‚
            const effectsDiv = document.createElement('div');
            effectsDiv.className = 'hidden-milestone-effects';
            
            // ç»„è£…
            wishItem.appendChild(imageDiv);
            wishItem.appendChild(textDiv);
            container.appendChild(wishItem);
            container.appendChild(timeDiv);
            container.appendChild(frameDiv);
            container.appendChild(effectsDiv);
            
            // æ·»åŠ åˆ°ç”»å¸ƒ
            canvas.appendChild(container);
        }
        
        function updateHiddenBackground(bgDiv, bgType) {
            switch(bgType) {
                case '1':
                    bgDiv.style.backgroundColor = '#FFF9F0';
                    bgDiv.style.backgroundImage = 'none';
                    break;
                case '2':
                    bgDiv.style.background = 'linear-gradient(135deg, #FFEEDD, #FFF9F0)';
                    break;
                case '3':
                    bgDiv.style.backgroundColor = '#FFF9F0';
                    bgDiv.style.backgroundImage = 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="%23FFB6C1" opacity="0.2"/></svg>\')';
                    break;
                case '4':
                    bgDiv.style.backgroundColor = '#FFF9F0';
                    bgDiv.style.backgroundImage = 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0.5" fill="%234ECDC4" opacity="0.1"/></svg>\')';
                    break;
                default:
                    bgDiv.style.backgroundColor = '#FFF9F0';
            }
        }
        
        function waitForImagesToLoad() {
            return new Promise((resolve) => {
                const hiddenCanvas = document.getElementById('hiddenVisionBoardCanvas');
                const images = hiddenCanvas.querySelectorAll('.hidden-wish-image[style*="background-image"]');
                
                if (images.length === 0) {
                    resolve();
                    return;
                }
                
                let loadedCount = 0;
                const totalImages = images.length;
                
                images.forEach(img => {
                    const bgImage = window.getComputedStyle(img).backgroundImage;
                    if (bgImage && bgImage !== 'none') {
                        const urlMatch = bgImage.match(/url\(['"]?(.+?)['"]?\)/);
                        if (urlMatch) {
                            const imgUrl = urlMatch[1];
                            const testImg = new Image();
                            testImg.onload = () => {
                                loadedCount++;
                                if (loadedCount >= totalImages) {
                                    setTimeout(resolve, 500); // é¢å¤–ç­‰å¾…500msç¡®ä¿æ¸²æŸ“å®Œæˆ
                                }
                            };
                            testImg.onerror = () => {
                                loadedCount++;
                                if (loadedCount >= totalImages) {
                                    setTimeout(resolve, 500);
                                }
                            };
                            testImg.src = imgUrl;
                        } else {
                            loadedCount++;
                            if (loadedCount >= totalImages) {
                                setTimeout(resolve, 500);
                            }
                        }
                    } else {
                        loadedCount++;
                        if (loadedCount >= totalImages) {
                            setTimeout(resolve, 500);
                        }
                    }
                });
            });
        }
        
        function captureVisionBoardAsImage() {
            return new Promise((resolve, reject) => {
                const hiddenCanvas = document.getElementById('hiddenVisionBoardCanvas');
                
                if (!hiddenCanvas) {
                    reject(new Error('æœªæ‰¾åˆ°éšè—æ„¿æ™¯æ¿ç”»å¸ƒ'));
                    return;
                }
                
                html2canvas(hiddenCanvas, {
                    backgroundColor: '#FFF9F0',
                    scale: 2, // é«˜åˆ†è¾¨ç‡
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: 1200,
                    height: 800,
                    windowWidth: 1200,
                    windowHeight: 800,
                    onclone: function(clonedDoc) {
                        // ç¡®ä¿å…‹éš†æ–‡æ¡£ä¸­æ‰€æœ‰å…ƒç´ éƒ½æ­£ç¡®æ˜¾ç¤º
                        const clonedCanvas = clonedDoc.getElementById('hiddenVisionBoardCanvas');
                        if (clonedCanvas) {
                            // ç¡®ä¿èƒŒæ™¯å¯è§
                            const bg = clonedCanvas.querySelector('.hidden-board-background');
                            if (bg) {
                                bg.style.display = 'block';
                                bg.style.visibility = 'visible';
                                bg.style.opacity = '1';
                            }
                            
                            // ç¡®ä¿æ‰€æœ‰æ„¿æœ›é¡¹ç›®å¯è§
                            const wishItems = clonedCanvas.querySelectorAll('.hidden-wish-item-container');
                            wishItems.forEach(item => {
                                item.style.display = 'block';
                                item.style.visibility = 'visible';
                                item.style.opacity = '1';
                                
                                // ç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
                                const wishImage = item.querySelector('.hidden-wish-image');
                                if (wishImage) {
                                    const bgImage = wishImage.style.backgroundImage;
                                    if (bgImage && bgImage !== 'none') {
                                        wishImage.style.backgroundImage = bgImage;
                                        wishImage.style.backgroundSize = 'cover';
                                        wishImage.style.backgroundPosition = 'center';
                                    }
                                }
                                
                                // ç¡®ä¿æ–‡å­—å¯è§
                                const wishText = item.querySelector('.hidden-wish-text');
                                if (wishText) {
                                    wishText.style.color = '#5D4037';
                                    wishText.style.visibility = 'visible';
                                }
                                
                                // ç¡®ä¿ä¸“æ³¨æ—¶é—´å¯è§
                                const focusTime = item.querySelector('.hidden-focus-time');
                                if (focusTime) {
                                    focusTime.style.visibility = 'visible';
                                }
                                
                                // ç¡®ä¿ç›¸æ¡†æ˜¾ç¤º
                                const frame = item.querySelector('.hidden-wish-frame');
                                if (frame) {
                                    frame.style.display = 'block';
                                    frame.style.visibility = 'visible';
                                }
                                
                                // ç¡®ä¿é‡Œç¨‹ç¢‘ç‰¹æ•ˆæ˜¾ç¤º
                                const effects = item.querySelector('.hidden-milestone-effects');
                                if (effects) {
                                    effects.style.display = 'block';
                                    effects.style.visibility = 'visible';
                                    effects.style.opacity = '1';
                                }
                            });
                            
                            // ç¡®ä¿æ‰€æœ‰è´´çº¸å¯è§
                            const stickers = clonedCanvas.querySelectorAll('.hidden-sticker-element');
                            stickers.forEach(sticker => {
                                sticker.style.display = 'block';
                                sticker.style.visibility = 'visible';
                                sticker.style.opacity = '1';
                            });
                        }
                    }
                }).then(function(canvas) {
                    // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡
                    const dataUrl = canvas.toDataURL('image/png', 1.0);
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    nftPlaceholder.style.display = 'none';
                    nftPreview.style.display = 'block';
                    nftPreview.src = dataUrl;
                    
                    // ä¿å­˜å›¾åƒURL
                    nftData.imageUrl = dataUrl;
                    
                    showNotification('NFTé¢„è§ˆç”Ÿæˆå®Œæˆ', 'success');
                    
                    // æ›´æ–°æ­¥éª¤2ä¸ºå®ŒæˆçŠ¶æ€
                    step2.classList.add('completed');
                    step2.innerHTML = '<i class="fas fa-check"></i>';
                    
                    resolve();
                }).catch(function(error) {
                    console.error('ç”ŸæˆNFTé¢„è§ˆå¤±è´¥:', error);
                    showNotification('ç”ŸæˆNFTé¢„è§ˆå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    nftPlaceholder.innerHTML = '<i class="fas fa-exclamation-circle"></i> ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
                    reject(error);
                });
            });
        }


        function setupEventListeners() {
            // é¢„è§ˆNFTæŒ‰é’®
            previewBtn.addEventListener('click', function() {
                showNotification('å·²åœ¨å·¦ä¾§å¡ç‰‡ä¸­æ˜¾ç¤ºNFTé¢„è§ˆ', 'info');
                
                // é«˜äº®æ˜¾ç¤ºNFTå¡ç‰‡
                const nftCard = document.querySelector('.nft-card');
                nftCard.style.animation = 'pulse-glow 2s 3';
                
                setTimeout(() => {
                    nftCard.style.animation = '';
                }, 6000);
            });
            
            // é“¸é€ NFTæŒ‰é’®
            mintBtn.addEventListener('click', function() {
                startMintingProcess();
            });
            
            // åˆ†äº«æˆå°±æŒ‰é’®
            shareBtn.addEventListener('click', function() {
                shareNFT();
            });
            
            // è¿›å…¥2026æ˜ŸçƒæŒ‰é’®
            enterPlanetBtn.addEventListener('click', function() {
                enterPlanet();
            });
            
            // ä¸‹è½½NFTå›¾åƒæŒ‰é’®
            downloadBtn.addEventListener('click', function() {
                downloadNFTImage();
            });
        }

        function startMintingProcess() {
            // ç¦ç”¨é“¸é€ æŒ‰é’®
            mintBtn.disabled = true;
            mintBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é“¸é€ ä¸­...';
            
            // æ›´æ–°æ­¥éª¤3ä¸ºè¿›è¡Œä¸­çŠ¶æ€
            step3.classList.add('active');
            
            // æ¨¡æ‹Ÿé“¸é€ è¿‡ç¨‹
            showNotification('å¼€å§‹NFTé“¸é€ è¿‡ç¨‹...', 'info');
            
            // æ­¥éª¤1: å‡†å¤‡æ•°æ®
            setTimeout(() => {
                showNotification('æ•°æ®éªŒè¯å®Œæˆ...', 'info');
                
                // æ­¥éª¤2: ç”Ÿæˆæœ€ç»ˆå›¾åƒï¼ˆå¦‚æœè¿˜æ²¡æœ‰ç”Ÿæˆï¼‰
                if (!nftData.imageUrl) {
                    showNotification('æ­£åœ¨ç”Ÿæˆæœ€ç»ˆNFTå›¾åƒ...', 'info');
                    
                    // é‡æ–°æ¸²æŸ“å¹¶æ•è·æ„¿æ™¯æ¿
                    renderHiddenVisionBoard().then(() => {
                        waitForImagesToLoad().then(() => {
                            captureVisionBoardAsImage().then(() => {
                                // å›¾åƒç”Ÿæˆå®Œæˆåç»§ç»­é“¸é€ æµç¨‹
                                proceedWithMinting();
                            });
                        });
                    });
                } else {
                    // å¦‚æœå·²æœ‰å›¾åƒï¼Œç›´æ¥ç»§ç»­
                    proceedWithMinting();
                }
            }, 1000);
        }
        
        async function proceedWithMinting() {
            showNotification('NFTå›¾åƒç”Ÿæˆå®Œæˆ...', 'info');
            
            // æ­¥éª¤3: ä¸Šé“¾é“¸é€ 
            try {
                showNotification('æ­£åœ¨è¿æ¥åŒºå—é“¾...', 'info');
                
                // è°ƒç”¨çœŸå®åŒºå—é“¾é“¸é€ 
                await realBlockchainMint();
                
            } catch (error) {
                console.error('é“¸é€ å¤±è´¥:', error);
                showNotification('é“¸é€ å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                mintBtn.disabled = false;
                mintBtn.innerHTML = '<i class="fas fa-gem"></i> å¼€å§‹é“¸é€ NFT';
                step3.classList.remove('active');
            }
        }

        async function realBlockchainMint() {
            try {
                // æ£€æŸ¥åˆçº¦æœåŠ¡æ˜¯å¦å¯ç”¨
                if (typeof contractService === 'undefined') {
                    // åŠ¨æ€å¯¼å…¥åˆçº¦æœåŠ¡
                    const contractModule = await import('../js/utils/contract.js');
                    window.contractService = contractModule.default;
                }
                
                const contract = window.contractService || contractService;
                
                // åˆå§‹åŒ–åˆçº¦ï¼ˆè‡ªåŠ¨æ£€æµ‹ç½‘ç»œï¼‰
                showNotification('æ­£åœ¨åˆå§‹åŒ–åˆçº¦è¿æ¥...', 'info');
                await contract.init('sepolia'); // é»˜è®¤ä½¿ç”¨Sepoliaæµ‹è¯•ç½‘
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ¨¡æ‹Ÿæ¨¡å¼
                if (contract.isSimulateMode && contract.isSimulateMode()) {
                    showNotification('âš ï¸ å½“å‰ä¸ºæ¨¡æ‹Ÿæ¨¡å¼ï¼ˆåˆçº¦æœªéƒ¨ç½²ï¼‰ï¼Œå°†æ¨¡æ‹Ÿé“¸é€ è¿‡ç¨‹', 'info');
                    // ç»§ç»­æ‰§è¡Œï¼Œä½†ä¼šä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼
                }
                
                // ä¸Šä¼ å›¾åƒåˆ°IPFSï¼ˆæš‚æ—¶ä½¿ç”¨base64ï¼Œå®é™…åº”è¯¥ä¸Šä¼ åˆ°IPFSï¼‰
                showNotification('æ­£åœ¨å‡†å¤‡NFTå…ƒæ•°æ®...', 'info');
                const tokenURI = await prepareTokenURI();
                
                // è·å–é“¸é€ ä»·æ ¼
                const mintPrice = await contract.getMintPrice();
                showNotification(`é“¸é€ ä»·æ ¼: ${mintPrice} ETH`, 'info');
                
                // è°ƒç”¨é“¸é€ å‡½æ•°
                showNotification('æ™ºèƒ½åˆçº¦è°ƒç”¨ä¸­ï¼Œè¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤äº¤æ˜“...', 'info');
                step3.classList.add('active');
                
                const result = await contract.mintNFT(
                    parseInt(nftData.year),
                    nftData.totalHours,
                    nftData.totalWishes,
                    nftData.completedWishes,
                    tokenURI
                );
                
                if (result.success) {
                    if (result.simulateMode) {
                        showNotification('âœ… æ¨¡æ‹Ÿé“¸é€ å®Œæˆï¼ˆåˆçº¦æœªéƒ¨ç½²ï¼Œè¿™æ˜¯æ¨¡æ‹Ÿç»“æœï¼‰', 'info');
                    } else {
                        showNotification('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                        // ç­‰å¾…äº¤æ˜“ç¡®è®¤
                        showNotification(`äº¤æ˜“å“ˆå¸Œ: ${result.txHash.substring(0, 10)}...`, 'info');
                    }
                    
                    // æ›´æ–°NFTæ•°æ®
                    nftData.minted = true;
                    nftData.tokenId = result.tokenId || 'pending';
                    nftData.contractAddress = contract.contractAddress || 'æ¨¡æ‹Ÿæ¨¡å¼';
                    nftData.mintTime = new Date().toLocaleString();
                    nftData.txHash = result.txHash;
                    nftData.simulateMode = result.simulateMode || false;
                    
                    // å®Œæˆé“¸é€ 
                    completeMinting(result);
                } else {
                    throw new Error('é“¸é€ å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åŒºå—é“¾é“¸é€ å¤±è´¥:', error);
                
                // å¤„ç†å¸¸è§é”™è¯¯
                let errorMessage = 'é“¸é€ å¤±è´¥';
                if (error.message.includes('user rejected') || error.message.includes('ç”¨æˆ·æ‹’ç»')) {
                    errorMessage = 'ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“';
                } else if (error.message.includes('Insufficient payment')) {
                    errorMessage = 'æ”¯ä»˜é‡‘é¢ä¸è¶³ï¼Œè¯·æ£€æŸ¥é’±åŒ…ä½™é¢';
                } else if (error.message.includes('Already minted')) {
                    errorMessage = 'è¯¥å¹´ä»½çš„NFTå·²é“¸é€ ';
                } else if (error.message.includes('è¯·å®‰è£…MetaMask')) {
                    errorMessage = 'è¯·å…ˆå®‰è£…å¹¶è¿æ¥MetaMaské’±åŒ…';
                } else {
                    errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                }
                
                throw new Error(errorMessage);
            }
        }
        
        async function prepareTokenURI() {
            // æš‚æ—¶è¿”å›base64æ•°æ®URIï¼Œå®é™…åº”è¯¥ä¸Šä¼ åˆ°IPFS
            // TODO: é›†æˆIPFSä¸Šä¼ æœåŠ¡ï¼ˆå¦‚Pinataã€NFT.Storageç­‰ï¼‰
            
            if (!nftData.imageUrl) {
                throw new Error('NFTå›¾åƒæœªç”Ÿæˆ');
            }
            
            // åˆ›å»ºå…ƒæ•°æ®JSON
            const metadata = {
                name: nftData.name,
                description: nftData.description,
                image: nftData.imageUrl, // å®é™…åº”è¯¥æ˜¯IPFSé“¾æ¥
                attributes: [
                    {
                        trait_type: "å¹´ä»½",
                        value: nftData.year
                    },
                    {
                        trait_type: "æ€»ä¸“æ³¨æ—¶é—´",
                        value: nftData.totalHours,
                        display_type: "number"
                    },
                    {
                        trait_type: "æ„¿æœ›æ€»æ•°",
                        value: nftData.totalWishes,
                        display_type: "number"
                    },
                    {
                        trait_type: "å®Œæˆæ„¿æœ›æ•°",
                        value: nftData.completedWishes,
                        display_type: "number"
                    },
                    {
                        trait_type: "é‡Œç¨‹ç¢‘æ•°",
                        value: nftData.milestones,
                        display_type: "number"
                    },
                    {
                        trait_type: "æ´»è·ƒåº¦",
                        value: nftData.activity,
                        display_type: "number"
                    },
                    {
                        trait_type: "ç¨€æœ‰åº¦",
                        value: nftData.rarity
                    }
                ]
            };
            
            // å°†å…ƒæ•°æ®è½¬æ¢ä¸ºbase64ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
            // å®é™…åº”è¯¥ä¸Šä¼ åˆ°IPFSå¹¶è¿”å›IPFS URI
            const metadataJson = JSON.stringify(metadata);
            const base64Metadata = btoa(unescape(encodeURIComponent(metadataJson)));
            
            // è¿”å›ä¸´æ—¶URIï¼ˆå®é™…åº”è¯¥æ˜¯ ipfs://...ï¼‰
            return `data:application/json;base64,${base64Metadata}`;
            
            // TODO: å®é™…IPFSä¸Šä¼ ä»£ç ç¤ºä¾‹ï¼š
            // const ipfsHash = await uploadToIPFS(metadataJson);
            // return `ipfs://${ipfsHash}`;
        }

        function completeMinting(result = null) {
            // å¦‚æœå·²æœ‰çœŸå®æ•°æ®ï¼Œä½¿ç”¨çœŸå®æ•°æ®ï¼›å¦åˆ™ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
            if (result && result.tokenId) {
                nftData.tokenId = `#${result.tokenId}`;
            } else if (!nftData.tokenId) {
                nftData.tokenId = `#${nftData.year}${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
            }
            
            if (!nftData.contractAddress) {
                // ä»åˆçº¦æœåŠ¡è·å–åˆçº¦åœ°å€
                if (window.contractService && window.contractService.contractAddress) {
                    nftData.contractAddress = window.contractService.contractAddress;
                } else {
                    nftData.contractAddress = `0x${Array.from({length: 40}, () => 
                        Math.floor(Math.random() * 16).toString(16)).join('')}`;
                }
            }
            
            if (!nftData.mintTime) {
                nftData.mintTime = new Date().toLocaleString();
            }
            
            nftData.minted = true;
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            step3.classList.remove('active');
            step3.classList.add('completed');
            step3.innerHTML = '<i class="fas fa-check"></i>';
            
            step4.classList.add('active');
            
            // æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
            setTimeout(() => {
                step4.classList.remove('active');
                step4.classList.add('completed');
                step4.innerHTML = '<i class="fas fa-check"></i>';
                
                // æ˜¾ç¤ºNFTè¯¦æƒ…
                showNFTDetails();
                
                // åˆ›å»ºåº†ç¥æ•ˆæœ
                createCelebration();
                
                // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
                playCelebrationSound();
                
                showNotification('ğŸ‰ NFTé“¸é€ æˆåŠŸï¼å·²æ°¸ä¹…è®°å½•åœ¨åŒºå—é“¾ä¸Š', 'success');
                
            }, 1000);
        }

        function showNFTDetails() {
            // æ›´æ–°è¯¦æƒ…ä¿¡æ¯
            finalNftName.textContent = nftData.name;
            tokenId.textContent = nftData.tokenId;
            contractAddress.textContent = nftData.contractAddress;
            mintTime.textContent = nftData.mintTime;
            
            // è®¾ç½®å›¾åƒ
            const finalNftImage = document.getElementById('finalNftImage');
            finalNftImage.src = nftData.imageUrl || nftPreview.src;
            
            // è®¾ç½®åŒºå—æµè§ˆå™¨é“¾æ¥
            const tokenIdNum = nftData.tokenId.replace('#', '');
            if (nftData.txHash) {
                explorerLink.href = `https://sepolia.etherscan.io/tx/${nftData.txHash}`;
                explorerLink.textContent = 'åœ¨åŒºå—æµè§ˆå™¨æŸ¥çœ‹äº¤æ˜“';
            } else {
                explorerLink.href = `https://sepolia.etherscan.io/token/${nftData.contractAddress}?a=${tokenIdNum}`;
                explorerLink.textContent = 'åœ¨åŒºå—æµè§ˆå™¨æŸ¥çœ‹NFT';
            }
            
            // æ˜¾ç¤ºè¯¦æƒ…åŒºåŸŸ
            nftDetails.style.display = 'block';
            
            // æ»šåŠ¨åˆ°è¯¦æƒ…åŒºåŸŸ
            nftDetails.scrollIntoView({
                behavior: 'smooth'
            });
        }

        function createCelebration() {
            // æ˜¾ç¤ºåº†ç¥å®¹å™¨
            celebration.style.display = 'block';
            
            // åˆ›å»ºå½©è‰²çº¸å±‘
            const colors = ['#9370DB', '#4ECDC4', '#FF6B8B', '#FFD700', '#45B7D1'];
            
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                
                // éšæœºé¢œè‰²
                const color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.backgroundColor = color;
                
                // éšæœºä½ç½®
                const x = Math.random() * 100;
                confetti.style.left = `${x}%`;
                
                // éšæœºå¤§å°
                const size = Math.random() * 8 + 4;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                
                // éšæœºå»¶è¿Ÿ
                const delay = Math.random() * 3;
                confetti.style.animationDelay = `${delay}s`;
                
                // éšæœºæ—‹è½¬
                const rotation = Math.random() * 360;
                confetti.style.transform = `rotate(${rotation}deg)`;
                
                celebration.appendChild(confetti);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 3000);
            }
            
            // 3ç§’åéšè—åº†ç¥å®¹å™¨
            setTimeout(() => {
                celebration.style.display = 'none';
                // æ¸…é™¤æ‰€æœ‰çº¸å±‘
                while (celebration.firstChild) {
                    celebration.removeChild(celebration.firstChild);
                }
            }, 3000);
        }

        function playCelebrationSound() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // åˆ›å»ºåº†ç¥éŸ³æ•ˆ
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        // éšæœºé¢‘ç‡ (åº†ç¥éŸ³è°ƒ)
                        oscillator.frequency.value = 600 + Math.random() * 400;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    }, i * 100);
                }
            } catch (e) {
                console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
            }
        }

        function shareNFT() {
            const shareText = `æˆ‘åˆšåœ¨ VisionFocus Hours é“¸é€ äº†æˆ‘çš„ ${nftData.year} å¹´åº¦NFTï¼è®°å½•äº† ${nftData.totalHours} å°æ—¶çš„ä¸“æ³¨æ—¶å…‰å’Œ ${nftData.completedWishes}/${nftData.totalWishes} ä¸ªå®ç°çš„æ„¿æœ›ã€‚`;
            
            if (navigator.share) {
                navigator.share({
                    title: `æˆ‘çš„${nftData.year}å¹´åº¦NFT`,
                    text: shareText,
                    url: window.location.href
                })
                .then(() => showNotification('åˆ†äº«æˆåŠŸï¼', 'success'))
                .catch(error => {
                    console.log('åˆ†äº«å¤±è´¥:', error);
                    copyToClipboard(shareText);
                });
            } else {
                copyToClipboard(shareText);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => showNotification('NFTä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'))
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
        }

        function enterPlanet() {
            showNotification(`ğŸš€ æ­£åœ¨è¿›å…¥${nftData.currentYear}æ˜Ÿçƒ...`, 'info');
            
            // æ¨¡æ‹ŸåŠ è½½è¿‡ç¨‹
            enterPlanetBtn.disabled = true;
            enterPlanetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¿›å…¥ä¸­...';
            
            // ä¿å­˜NFTçŠ¶æ€
            saveNFTState();
            
            // æ›´æ–°æ˜ŸçƒçŠ¶æ€
            updatePlanet(nftData.currentYear, {
                nftMinted: true,
                nftMintedAt: new Date().toISOString(),
                nft: {
                    tokenId: nftData.tokenId,
                    contractAddress: nftData.contractAddress,
                    mintTime: nftData.mintTime,
                    imageUrl: nftData.imageUrl
                }
            });
            
            // 2ç§’åè·³è½¬
            setTimeout(() => {
                window.location.href = `home.html`;
            }, 1500);
        }

        function downloadNFTImage() {
            if (!nftData.imageUrl) {
                showNotification('NFTå›¾åƒå°šæœªç”Ÿæˆ', 'error');
                return;
            }
            
            showNotification('æ­£åœ¨ä¸‹è½½NFTå›¾åƒ...', 'info');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const downloadLink = document.createElement('a');
            downloadLink.href = nftData.imageUrl;
            downloadLink.download = `VisionFocus_Hours_${nftData.year}_NFT.png`;
            
            // æ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            setTimeout(() => {
                showNotification('NFTå›¾åƒä¸‹è½½å®Œæˆï¼', 'success');
            }, 1000);
        }

        function saveNFTState() {
            try {
                const nftState = {
                    name: nftData.name,
                    year: nftData.year,
                    totalHours: nftData.totalHours,
                    totalWishes: nftData.totalWishes,
                    completedWishes: nftData.completedWishes,
                    milestones: nftData.milestones,
                    activity: nftData.activity,
                    minted: nftData.minted,
                    tokenId: nftData.tokenId,
                    contractAddress: nftData.contractAddress,
                    mintTime: nftData.mintTime,
                    imageUrl: nftData.imageUrl
                };
                
                // ä½¿ç”¨å¹´ä»½ç›¸å…³çš„keyä¿å­˜
                const nftKey = `nft_${nftData.currentYear}`;
                setStorageData(nftKey, nftState);
                
                return true;
            } catch (e) {
                console.error('ä¿å­˜NFTçŠ¶æ€å¤±è´¥:', e);
                return false;
            }
        }
        
        function loadUserData() {
            // å°è¯•åŠ è½½å·²ä¿å­˜çš„NFTçŠ¶æ€
            const nftKey = `nft_${nftData.currentYear}`;
            const savedNFT = getStorageData(nftKey);
            
            if (savedNFT && savedNFT.minted) {
                // å¦‚æœå·²ç»é“¸é€ è¿‡ï¼Œæ¢å¤çŠ¶æ€
                nftData.minted = savedNFT.minted;
                nftData.tokenId = savedNFT.tokenId;
                nftData.contractAddress = savedNFT.contractAddress;
                nftData.mintTime = savedNFT.mintTime;
                nftData.imageUrl = savedNFT.imageUrl;
                
                // æ˜¾ç¤ºNFTè¯¦æƒ…
                showNFTDetails();
                
                // æ›´æ–°æ­¥éª¤çŠ¶æ€
                step1.classList.add('completed');
                step1.innerHTML = '<i class="fas fa-check"></i>';
                step2.classList.add('completed');
                step2.innerHTML = '<i class="fas fa-check"></i>';
                step3.classList.add('completed');
                step3.innerHTML = '<i class="fas fa-check"></i>';
                step4.classList.add('completed');
                step4.innerHTML = '<i class="fas fa-check"></i>';
                
                mintBtn.disabled = true;
                mintBtn.innerHTML = '<i class="fas fa-check"></i> å·²é“¸é€ ';
                
                showNotification('å·²åŠ è½½å·²é“¸é€ çš„NFTä¿¡æ¯', 'info');
            }
        }

        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 25px;
                right: 25px;
                background-color: ${type === 'error' ? 'rgba(255, 107, 139, 0.95)' : type === 'success' ? 'rgba(78, 205, 196, 0.95)' : 'rgba(20, 20, 40, 0.95)'};
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 20px rgba(0,0,0,0.25);
                z-index: 10000;
                border-left: 5px solid ${type === 'error' ? '#FF6B8B' : type === 'success' ? '#4ECDC4' : '#9370DB'};
                animation: slideIn 0.4s ease, fadeOut 0.4s ease 2.5s forwards;
                max-width: 350px;
                font-family: 'Ma Shan Zheng', cursive;
                border: 1px solid ${type === 'error' ? 'rgba(255, 107, 139, 0.3)' : type === 'success' ? 'rgba(78, 205, 196, 0.3)' : 'rgba(147, 112, 219, 0.3)'};
                backdrop-filter: blur(10px);
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}" 
                       style="font-size: 1.4rem; color: ${type === 'error' ? '#FF6B8B' : type === 'success' ? '#4ECDC4' : '#9370DB'};"></i>
                    <div style="color: white; font-size: 1.05rem; line-height: 1.4;">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
            
            // æ·»åŠ CSSåŠ¨ç”»
            if (!document.getElementById('notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
    </script>
</body>
</html>