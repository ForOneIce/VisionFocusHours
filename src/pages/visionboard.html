<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionFocus Hours Â· æ²‰æµ¸å¼æ„¿æ™¯æ¿ç¼–è¾‘</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-light: #FFF9F0;
            --primary-warm: #FFEEDD;
            --accent-pink: #FFB6C1;
            --accent-gold: #FFD700;
            --accent-purple: #DDA0DD;
            --text-brown: #8B4513;
            --text-dark: #5D4037;
            --shadow-soft: rgba(255, 182, 193, 0.2);
            --border-radius: 20px;
            --transition-slow: 0.8s ease;
            --transition-normal: 0.4s ease;
            --planet-1: #4ECDC4;
            --planet-2: #FF6B8B;
            --planet-3: #45B7D1;
            --planet-4: #96CEB4;
            --planet-5: #FFEAA7;
            --night-blue: #0A0A1A;
            --board-bg-1: rgba(255, 182, 193, 0.1);
            --board-bg-2: rgba(221, 160, 221, 0.1);
            --frame-color-1: #FFB6C1;
            --frame-color-2: #DDA0DD;
            --frame-color-3: #4ECDC4;
            --frame-color-4: #FFD700;
            --sidebar-width: 340px;
            --canvas-padding: 40px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif SC', 'ZCOOL XiaoWei', serif;
            background-color: var(--night-blue);
            color: #F0F0F0;
            overflow-x: hidden;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(106, 90, 205, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255, 107, 139, 0.1) 0%, transparent 40%);
        }

        /* å®‡å®™èƒŒæ™¯ */
        .universe-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* ä¸»å®¹å™¨ */
        .visionboard-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* å¤´éƒ¨ */
        .visionboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
            flex-wrap: wrap;
        }

        .logo {
            font-family: 'ZCOOL QingKe HuangYou', cursive;
            font-size: 2.5rem;
            color: var(--planet-1);
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 2.2rem;
            color: var(--planet-1);
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            text-align: right;
        }

        .current-planet {
            font-size: 1.2rem;
            color: var(--planet-1);
            font-weight: bold;
        }

        .progress-indicator {
            font-size: 0.95rem;
            color: #CCCCCC;
            background: rgba(20, 20, 40, 0.7);
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        /* å¼•å¯¼åŒºåŸŸ */
        .guide-section {
            text-align: center;
            padding: 25px 15px;
            margin-bottom: 20px;
            position: relative;
            background: rgba(20, 20, 40, 0.4);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .guide-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.8rem;
            color: var(--planet-1);
            margin-bottom: 15px;
            text-shadow: 
                0 0 10px rgba(78, 205, 196, 0.5),
                0 0 20px rgba(78, 205, 196, 0.3);
        }

        .guide-subtitle {
            font-size: 1.5rem;
            color: #FFFFFF;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .guide-text {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto 20px;
            line-height: 1.6;
            color: #CCCCCC;
        }

        .highlight {
            color: var(--planet-1);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
        }

        /* ä¸»ç¼–è¾‘å·¥ä½œåŒº - æ ¸å¿ƒé‡æ„éƒ¨åˆ† */
        .editor-workspace {
            display: flex;
            height: calc(100vh - 250px);
            min-height: 650px;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        /* ä¾§è¾¹å·¥å…·æ  - ç´§å‡‘è®¾è®¡ */
        .editor-sidebar {
            width: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }

        /* ä¾§è¾¹æ é¢æ¿é€šç”¨æ ·å¼ */
        .sidebar-panel {
            background: rgba(20, 20, 40, 0.85);
            border-radius: 16px;
            border: 2px solid rgba(255, 182, 193, 0.2);
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.4rem;
            color: var(--planet-1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            font-size: 1.3rem;
        }

        /* å·¥å…·å›¾æ ‡æ  */
        .tools-panel {
            padding: 20px 15px;
        }

        .toolbar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .tool-btn {
            aspect-ratio: 1;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.07);
            border: 2px solid transparent;
            color: #CCCCCC;
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.25s ease;
        }

        .tool-btn:hover {
            background: rgba(78, 205, 196, 0.15);
            color: var(--planet-1);
            transform: translateY(-3px);
            border-color: rgba(78, 205, 196, 0.3);
        }

        .tool-btn.active {
            background: rgba(78, 205, 196, 0.25);
            border-color: var(--planet-1);
            color: var(--planet-1);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        .tool-label {
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* æ„¿æœ›åˆ—è¡¨ */
        .wishes-panel {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .wishes-list-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .wish-list-item {
            display: flex;
            align-items: center;
            padding: 14px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .wish-list-item:hover {
            background: rgba(78, 205, 196, 0.1);
            transform: translateX(3px);
        }

        .wish-list-item.active {
            background: rgba(78, 205, 196, 0.2);
            border-left-color: var(--planet-1);
            box-shadow: 0 3px 10px rgba(78, 205, 196, 0.15);
        }

        .wish-number {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: 50%;
            background-color: var(--planet-1);
            color: var(--night-blue);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1rem;
            margin-right: 14px;
        }

        .wish-text {
            flex: 1;
            font-size: 1rem;
            color: #E0E0E0;
            line-height: 1.3;
            word-break: break-word;
            max-height: 2.6em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .wish-status {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .wish-status:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: scale(1.1);
        }

        .wish-status.has-image {
            background: rgba(78, 205, 196, 0.25);
            color: var(--planet-1);
        }

        /* è£…é¥°å…ƒç´  */
        .decorations-panel {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .decorations-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .decoration-item {
            aspect-ratio: 1;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.8rem;
        }

        .decoration-item:hover {
            background: rgba(78, 205, 196, 0.15);
            transform: scale(1.1) translateY(-3px);
        }

        /* å±æ€§é¢æ¿ */
        .properties-panel {
            min-height: 180px;
        }

        .properties-content {
            display: none;
        }

        .properties-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-title {
            font-size: 1rem;
            color: #AAAAAA;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .property-option {
            aspect-ratio: 1;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .property-option:hover {
            transform: scale(1.05);
        }

        .property-option.active {
            border-color: var(--planet-1);
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .frame-option {
            border: 3px solid;
            border-radius: 5px;
        }

        .frame-option.type-1 {
            border-color: var(--frame-color-1);
        }

        .frame-option.type-2 {
            border-color: var(--frame-color-2);
            border-style: dashed;
        }

        .frame-option.type-3 {
            border-color: var(--frame-color-3);
        }

        .frame-option.type-4 {
            border-color: var(--frame-color-4);
        }

        .bg-option {
            background-size: cover;
            background-position: center;
        }

        .bg-option.type-1 {
            background-color: #FFF9F0;
        }

        .bg-option.type-2 {
            background: linear-gradient(135deg, #FFEEDD, #FFF9F0);
        }

        .bg-option.type-3 {
            background-color: #FFF9F0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="%23FFB6C1" opacity="0.2"/></svg>');
        }

        .bg-option.type-4 {
            background-color: #FFF9F0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0.5" fill="%234ECDC4" opacity="0.1"/></svg>');
        }

        /* ä¸»ç”»å¸ƒåŒºåŸŸ - å æ®ä¸»è¦ç©ºé—´ */
        .canvas-container {
            flex: 1;
            background-color: rgba(10, 10, 26, 0.4);
            border-radius: 18px;
            border: 2px solid rgba(255, 182, 193, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .canvas-header {
            padding: 18px 25px;
            background: rgba(20, 20, 40, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .canvas-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.8rem;
            color: var(--planet-1);
        }

        .canvas-actions {
            display: flex;
            gap: 12px;
        }

        .canvas-btn {
            padding: 8px 18px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #CCCCCC;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .canvas-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            color: var(--planet-1);
            border-color: rgba(78, 205, 196, 0.3);
        }

        .canvas-btn.primary {
            background: rgba(78, 205, 196, 0.25);
            color: var(--planet-1);
            font-weight: bold;
        }

        .canvas-btn.primary:hover {
            background: rgba(78, 205, 196, 0.35);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.2);
        }

        .canvas-area {
            flex: 1;
            overflow: auto;
            padding: var(--canvas-padding);
            background-color: #FFF9F0;
            background-image: 
                linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),
                linear-gradient(#eee .1em, transparent .1em);
            background-size: 100% 1.2em;
            position: relative;
        }

        #visionboardCanvas {
            width: 1200px;
            height: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: visible; /* æ”¹ä¸ºvisibleä»¥ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½èƒ½è¢«æ•è· */
        }

        /* æ„¿æ™¯æ¿ä¸Šçš„å…ƒç´ æ ·å¼ */
        .board-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .wish-item-container {
            position: absolute;
            z-index: 1;
            transition: all 0.2s ease;
            cursor: move;
        }

        .wish-item-container.selected {
            z-index: 10;
            box-shadow: 0 0 0 3px var(--planet-1), 0 0 20px rgba(78, 205, 196, 0.4);
        }

        .wish-item {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .wish-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .wish-image {
            width: 100%;
            height: 70%;
            object-fit: cover;
            background-color: #f5f5f5;
        }

        .wish-image.placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            color: #999;
            font-size: 2rem;
        }

        .wish-text {
            padding: 15px;
            height: 30%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: white;
            text-align: center;
            font-size: 1.05rem;
            color: var(--text-dark);
            font-weight: 500;
            line-height: 1.3;
            overflow: hidden;
        }

        .wish-frame {
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 8px solid;
            border-image-slice: 8;
            border-image-width: 8px;
            border-image-repeat: stretch;
            pointer-events: none;
            z-index: 2;
        }

        .wish-frame.type-1 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23FFB6C1" stroke-width="5" rx="10"/></svg>');
        }

        .wish-frame.type-2 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23DDA0DD" stroke-width="5" rx="10" stroke-dasharray="10,5"/></svg>');
        }

        .wish-frame.type-3 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%234ECDC4" stroke-width="5" rx="10"/><circle cx="10" cy="10" r="3" fill="%234ECDC4"/><circle cx="90" cy="10" r="3" fill="%234ECDC4"/><circle cx="10" cy="90" r="3" fill="%234ECDC4"/><circle cx="90" cy="90" r="3" fill="%234ECDC4"/></svg>');
        }

        .wish-frame.type-4 {
            border-image-source: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23FFD700" stroke-width="5" rx="10"/><path d="M10,10 L90,10 M90,10 L90,90 M90,90 L10,90 M10,90 L10,10" stroke="%23FFD700" stroke-width="2"/></svg>');
        }

        .wish-controls {
            position: absolute;
            top: -35px;
            right: -10px;
            display: none;
            gap: 8px;
            z-index: 11;
        }

        .wish-item-container.selected .wish-controls {
            display: flex;
        }

        .wish-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--planet-1);
            border: 2px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: white;
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .wish-control-btn:hover {
            transform: scale(1.1);
        }

        .wish-control-btn.delete {
            background-color: #FF6B8B;
        }

        .wish-control-btn.resize {
            background-color: #45B7D1;
        }

        .wish-control-btn.rotate {
            background-color: #96CEB4;
        }

        .sticker-element {
            position: absolute;
            z-index: 5;
            cursor: move;
            user-select: none;
            font-size: 50px;
            transition: all 0.2s;
        }

        .sticker-element:hover {
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
        }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        .bottom-controls {
            margin-top: 20px;
            padding: 20px;
            background: rgba(20, 20, 40, 0.6);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .hand-drawn-btn {
            background-color: var(--accent-pink);
            color: var(--text-brown);
            border: 2px solid var(--text-brown);
            border-radius: 255px 15px 225px 15px/15px 225px 15px 255px;
            padding: 12px 24px;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.4s;
            position: relative;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
        }

        .hand-drawn-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.3);
            background-color: #FFA7B3;
        }

        .hand-drawn-btn.primary {
            background-color: var(--planet-1);
            color: var(--night-blue);
            border-color: var(--planet-1);
            font-weight: bold;
        }

        .hand-drawn-btn.primary:hover {
            background-color: #3DBBB2;
            box-shadow: 0 5px 20px rgba(78, 205, 196, 0.4);
        }

        .status-info {
            color: #AAAAAA;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .editor-workspace {
                height: calc(100vh - 220px);
            }
            
            :root {
                --sidebar-width: 300px;
                --canvas-padding: 30px;
            }
        }

        @media (max-width: 1200px) {
            .editor-workspace {
                flex-direction: column;
                height: auto;
                min-height: 500px;
            }
            
            .editor-sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .sidebar-panel {
                flex: 1;
                min-width: 280px;
            }
            
            .canvas-container {
                height: 600px;
            }
        }

        @media (max-width: 768px) {
            .guide-title {
                font-size: 2.2rem;
            }
            
            .guide-subtitle {
                font-size: 1.3rem;
            }
            
            .guide-text {
                font-size: 1rem;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .header-info {
                align-items: flex-start;
                margin-top: 10px;
            }
            
            .canvas-area {
                padding: 20px;
            }
            
            #visionboardCanvas {
                width: 100%;
                height: 500px;
            }
            
            .sidebar-panel {
                min-width: 100%;
            }
            
            .bottom-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- å®‡å®™èƒŒæ™¯ -->
    <div class="universe-bg" id="universeBg"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="visionboard-container">
        <!-- å¤´éƒ¨ -->
        <header class="visionboard-header">
            <div class="logo">
                <i class="fas fa-globe-americas logo-icon"></i>
                <span>VisionFocus Hours</span>
            </div>
            <div class="header-info">
                <div class="current-planet" id="planetDisplay">2026æ˜Ÿçƒ Â· æ„¿æ™¯æ¿åˆ¶ä½œ</div>
                <div class="progress-indicator">æ­¥éª¤ 3/5 Â· å¯è§†åŒ–æ„¿æ™¯</div>
            </div>
        </header>

        <!-- å¼•å¯¼åŒºåŸŸ -->
        <section class="guide-section">
            <h1 class="guide-title">åˆ›ä½œä½ çš„è§†è§‰æ„¿æ™¯æ¿</h1>
            <h2 class="guide-subtitle">å°†æ–‡å­—æ„¿æœ›è½¬åŒ–ä¸ºè§†è§‰å›¾åƒï¼Œè®©æœªæ¥è§¦æ‰‹å¯åŠ</h2>
            <p class="guide-text">
                ä¸ºæ¯ä¸ªæ„¿æœ›ç¢ç‰‡<span class="highlight">ä¸Šä¼ å›¾ç‰‡</span>ï¼Œæ·»åŠ <span class="highlight">ç›¸æ¡†å’Œè£…é¥°</span>ï¼Œ<br>
                è‡ªç”±å¸ƒå±€ä½ çš„æ„¿æ™¯æ¿ã€‚è¿™æ˜¯ä½ æœªæ¥ä¸€å¹´çš„<span class="highlight">è§†è§‰æŒ‡å¼•</span>ã€‚
            </p>
        </section>

        <!-- ä¸»ç¼–è¾‘å·¥ä½œåŒº -->
        <div class="editor-workspace">
            <!-- ä¾§è¾¹å·¥å…·æ  -->
            <div class="editor-sidebar">
                <!-- å·¥å…·é¢æ¿ -->
                <div class="sidebar-panel tools-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-tools"></i> ç¼–è¾‘å·¥å…·
                        </div>
                    </div>
                    <div class="toolbar-grid">
                        <button class="tool-btn active" id="toolSelect" data-tool="select">
                            <i class="fas fa-mouse-pointer"></i>
                            <span class="tool-label">é€‰æ‹©</span>
                        </button>
                        <button class="tool-btn" id="toolMove" data-tool="move">
                            <i class="fas fa-arrows-alt"></i>
                            <span class="tool-label">ç§»åŠ¨</span>
                        </button>
                        <button class="tool-btn" id="toolSticker" data-tool="sticker">
                            <i class="fas fa-star"></i>
                            <span class="tool-label">è´´çº¸</span>
                        </button>
                        <button class="tool-btn" id="toolFrame" data-tool="frame">
                            <i class="fas fa-square"></i>
                            <span class="tool-label">ç›¸æ¡†</span>
                        </button>
                        <button class="tool-btn" id="toolText" data-tool="text">
                            <i class="fas fa-font"></i>
                            <span class="tool-label">æ–‡å­—</span>
                        </button>
                        <button class="tool-btn" id="toolDelete" data-tool="delete">
                            <i class="fas fa-trash-alt"></i>
                            <span class="tool-label">åˆ é™¤</span>
                        </button>
                    </div>
                </div>

                <!-- æ„¿æœ›åˆ—è¡¨é¢æ¿ -->
                <div class="sidebar-panel wishes-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-gem"></i> æ„¿æœ›ç¢ç‰‡
                        </div>
                        <span class="wish-count" id="wishCount">0/12</span>
                    </div>
                    <div class="wishes-list-container" id="wishesList">
                        <!-- æ„¿æœ›åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å±æ€§é¢æ¿ -->
                <div class="sidebar-panel properties-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-sliders-h"></i> å±æ€§è®¾ç½®
                        </div>
                    </div>
                    
                    <!-- å›¾ç‰‡ä¸Šä¼ å±æ€§ -->
                    <div class="properties-content active" id="propertiesImage">
                        <div class="property-group">
                            <div class="property-title">
                                <i class="fas fa-image"></i> å›¾ç‰‡ä¸Šä¼ 
                            </div>
                            <div style="text-align: center;">
                                <button class="canvas-btn" id="uploadImageBtn" style="width: 100%; justify-content: center;">
                                    <i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ å›¾ç‰‡
                                </button>
                                <input type="file" id="imageUploadInput" accept="image/*" style="display: none;">
                                <p style="color: #888; font-size: 0.85rem; margin-top: 10px;">æ”¯æŒ JPG, PNG, GIF (æœ€å¤§ 2MB)</p>
                            </div>
                        </div>
                        
                        <div class="property-group">
                            <div class="property-title">
                                <i class="fas fa-crop-alt"></i> ç›¸æ¡†æ ·å¼
                            </div>
                            <div class="property-grid">
                                <div class="property-option frame-option type-1 active" data-frame="1"></div>
                                <div class="property-option frame-option type-2" data-frame="2"></div>
                                <div class="property-option frame-option type-3" data-frame="3"></div>
                                <div class="property-option frame-option type-4" data-frame="4"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- èƒŒæ™¯å±æ€§ -->
                    <div class="properties-content" id="propertiesBackground">
                        <div class="property-group">
                            <div class="property-title">
                                <i class="fas fa-layer-group"></i> èƒŒæ™¯å›¾æ¡ˆ
                            </div>
                            <div class="property-grid">
                                <div class="property-option bg-option type-1 active" data-bg="1"></div>
                                <div class="property-option bg-option type-2" data-bg="2"></div>
                                <div class="property-option bg-option type-3" data-bg="3"></div>
                                <div class="property-option bg-option type-4" data-bg="4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è£…é¥°å…ƒç´ é¢æ¿ -->
                <div class="sidebar-panel decorations-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-palette"></i> è£…é¥°å…ƒç´ 
                        </div>
                        <button class="canvas-btn" id="clearDecorationsBtn" style="padding: 5px 10px; font-size: 0.9rem;">
                            <i class="fas fa-broom"></i> æ¸…ç©º
                        </button>
                    </div>
                    <div class="decorations-grid" id="decorationsGrid">
                        <!-- è£…é¥°å…ƒç´ å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¸»ç”»å¸ƒåŒºåŸŸ -->
            <div class="canvas-container">
                <div class="canvas-header">
                    <div class="canvas-title" id="canvasTitle">æˆ‘çš„2026æ„¿æ™¯æ¿</div>
                    <div class="canvas-actions">
                        <button class="canvas-btn" id="zoomInBtn">
                            <i class="fas fa-search-plus"></i> æ”¾å¤§
                        </button>
                        <button class="canvas-btn" id="zoomOutBtn">
                            <i class="fas fa-search-minus"></i> ç¼©å°
                        </button>
                        <button class="canvas-btn primary" id="saveImageBtn">
                            <i class="fas fa-download"></i> ä¿å­˜å›¾ç‰‡
                        </button>
                    </div>
                </div>
                <div class="canvas-area">
                    <div id="visionboardCanvas">
                        <!-- èƒŒæ™¯ -->
                        <div class="board-background" id="boardBackground"></div>
                        
                        <!-- æ„¿æœ›ç¢ç‰‡å’Œè£…é¥°å…ƒç´ å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æ§åˆ¶åŒº -->
        <div class="bottom-controls">
            <div class="control-group">
                <button class="hand-drawn-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i> è¿”å›ä¸Šä¸€æ­¥
                </button>
                <button class="hand-drawn-btn" id="saveDraftBtn">
                    <i class="fas fa-save"></i> ä¿å­˜è‰ç¨¿
                </button>
                <button class="hand-drawn-btn" id="loadDraftBtn">
                    <i class="fas fa-folder-open"></i> åŠ è½½è‰ç¨¿
                </button>
            </div>
            
            <div class="status-info">
                <span id="selectionInfo">æœªé€‰ä¸­ä»»ä½•å…ƒç´ </span>
                <span id="canvasInfo">ç”»å¸ƒå¤§å°: 1200Ã—800</span>
            </div>
            
            <div class="control-group">
                <button class="hand-drawn-btn primary" id="completeBtn">
                    å®Œæˆæ„¿æ™¯æ¿ <i class="fas fa-rocket"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // LocalStorageç®¡ç†
        const STORAGE_PREFIX = 'vfh_';
        
        function getStorageData(key) {
            try {
                const data = localStorage.getItem(STORAGE_PREFIX + key);
                return data ? JSON.parse(data) : null;
            } catch (e) {
                console.error('Storage error:', e);
                return null;
            }
        }
        
        function setStorageData(key, value) {
            try {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Storage error:', e);
                return false;
            }
        }
        
        function getPlanet(year) {
            const planets = getStorageData('planets') || [];
            return planets.find(p => p.year === parseInt(year));
        }
        
        function updatePlanet(year, updates) {
            const planets = getStorageData('planets') || [];
            const index = planets.findIndex(p => p.year === parseInt(year));
            
            if (index !== -1) {
                planets[index] = { ...planets[index], ...updates };
                setStorageData('planets', planets);
                return planets[index];
            }
            return null;
        }
        
        // æ„¿æ™¯æ¿æ•°æ®
        const visionBoard = {
            currentYear: new Date().getFullYear(),
            wishes: [],
            selectedWishId: null,
            selectedTool: 'select',
            selectedFrameType: '1',
            selectedBackgroundType: '1',
            stickers: [],
            canvasScale: 1,
            canvasWidth: 1200,
            canvasHeight: 800,
            
            // è£…é¥°å…ƒç´ 
            decorations: [
                { id: 1, icon: 'fas fa-star', content: 'â­' },
                { id: 2, icon: 'fas fa-heart', content: 'â¤ï¸' },
                { id: 3, icon: 'fas fa-cloud', content: 'â˜ï¸' },
                { id: 4, icon: 'fas fa-sun', content: 'â˜€ï¸' },
                { id: 5, icon: 'fas fa-moon', content: 'ğŸŒ™' },
                { id: 6, icon: 'fas fa-bolt', content: 'âš¡' },
                { id: 7, icon: 'fas fa-music', content: 'ğŸµ' },
                { id: 8, icon: 'fas fa-book', content: 'ğŸ“š' },
                { id: 9, icon: 'fas fa-plane', content: 'âœˆï¸' },
                { id: 10, icon: 'fas fa-tree', content: 'ğŸŒ³' },
                { id: 11, icon: 'fas fa-coffee', content: 'â˜•' },
                { id: 12, icon: 'fas fa-graduation-cap', content: 'ğŸ“' }
            ],
            
            // èƒŒæ™¯é€‰é¡¹
            backgrounds: [
                { id: 1, name: 'çº¯è‰²ç¾Šçš®çº¸', type: '1' },
                { id: 2, name: 'æ¸å˜æ¸©æš–', type: '2' },
                { id: 3, name: 'ç²‰è‰²åœ†ç‚¹', type: '3' },
                { id: 4, name: 'è“è‰²åœ†ç‚¹', type: '4' }
            ]
        };

        // DOMå…ƒç´ 
        const universeBg = document.getElementById('universeBg');
        const visionboardCanvas = document.getElementById('visionboardCanvas');
        const boardBackground = document.getElementById('boardBackground');
        const wishesList = document.getElementById('wishesList');
        const wishCount = document.getElementById('wishCount');
        const decorationsGrid = document.getElementById('decorationsGrid');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const propertiesImage = document.getElementById('propertiesImage');
        const propertiesBackground = document.getElementById('propertiesBackground');
        const selectionInfo = document.getElementById('selectionInfo');
        const backBtn = document.getElementById('backBtn');
        const completeBtn = document.getElementById('completeBtn');
        
        // å·¥å…·æŒ‰é’®
        const toolButtons = {
            select: document.getElementById('toolSelect'),
            move: document.getElementById('toolMove'),
            sticker: document.getElementById('toolSticker'),
            frame: document.getElementById('toolFrame'),
            text: document.getElementById('toolText'),
            delete: document.getElementById('toolDelete')
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
            createStarBackground();
            loadWishesFromStorage();
            createDecorationsGrid();
            updateCanvasBackground();
            updatePropertiesPanel();
        });

        function initApp() {
            // ä»URLè·å–å¹´ä»½å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            visionBoard.currentYear = parseInt(urlParams.get('year')) || new Date().getFullYear();
            
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.getElementById('planetDisplay').textContent = `${visionBoard.currentYear}æ˜Ÿçƒ Â· æ„¿æ™¯æ¿åˆ¶ä½œ`;
            document.getElementById('canvasTitle').textContent = `æˆ‘çš„${visionBoard.currentYear}æ„¿æ™¯æ¿`;
            
            // è®¾ç½®ç”»å¸ƒå¤§å°
            visionboardCanvas.style.width = `${visionBoard.canvasWidth}px`;
            visionboardCanvas.style.height = `${visionBoard.canvasHeight}px`;
            
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ„¿æ™¯æ¿çŠ¶æ€
            loadVisionBoardState();
        }

        function createStarBackground() {
            const starCount = 150;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // éšæœºä½ç½®
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                
                // éšæœºå¤§å°
                const size = Math.random() * 3 + 1;
                
                // éšæœºé—ªçƒå»¶è¿Ÿ
                const delay = Math.random() * 3;
                
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${delay}s`;
                
                universeBg.appendChild(star);
            }
        }

        function loadWishesFromStorage() {
            try {
                // ä»LocalStorageåŠ è½½å¯¹åº”å¹´ä»½çš„æ„¿æœ›æ•°æ®
                const key = `wishes_${visionBoard.currentYear}`;
                const savedWishes = getStorageData(key);
                
                if (savedWishes && savedWishes.length > 0) {
                    // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¿å­˜çš„æ„¿æ™¯æ¿çŠ¶æ€ï¼ˆåŒ…å«ä½ç½®ã€å›¾ç‰‡ç­‰ä¿¡æ¯ï¼‰
                    const boardStateKey = `visionboard_${visionBoard.currentYear}`;
                    const savedBoardState = getStorageData(boardStateKey);
                    
                    if (savedBoardState && savedBoardState.wishes && savedBoardState.wishes.length > 0) {
                        // ä½¿ç”¨å·²ä¿å­˜çš„æ„¿æ™¯æ¿çŠ¶æ€ï¼ˆåŒ…å«ä½ç½®ã€å›¾ç‰‡ç­‰ï¼‰
                        visionBoard.wishes = savedBoardState.wishes;
                        visionBoard.stickers = savedBoardState.stickers || [];
                        visionBoard.selectedBackgroundType = savedBoardState.backgroundType || '1';
                    } else {
                        // ä»æ„¿æœ›ç¢ç‰‡åˆ›å»ºæ„¿æ™¯æ¿é¡¹ç›®
                        visionBoard.wishes = savedWishes.map((wish, index) => ({
                            ...wish,
                            image: null,
                            frameType: '1',
                            position: {
                                x: 50 + (index % 3) * 300,
                                y: 50 + Math.floor(index / 3) * 250
                            },
                            size: {
                                width: 250,
                                height: 300
                            },
                            rotation: 0,
                            zIndex: index + 1
                        }));
                    }
                    
                    // æ›´æ–°æ„¿æœ›è®¡æ•°
                    updateWishCount();
                    
                    // æ¸²æŸ“æ„¿æœ›åˆ—è¡¨
                    renderWishesList();
                    
                    // åœ¨ç”»å¸ƒä¸Šåˆ›å»ºæ„¿æœ›é¡¹ç›®
                    createWishItemsOnCanvas();
                    
                    // æ¢å¤è´´çº¸
                    if (visionBoard.stickers && visionBoard.stickers.length > 0) {
                        visionBoard.stickers.forEach(stickerData => {
                            const sticker = document.createElement('div');
                            sticker.className = 'sticker-element';
                            sticker.innerHTML = `<div style="text-align: center;">${stickerData.content}</div>`;
                            
                            sticker.style.left = `${stickerData.position.x}px`;
                            sticker.style.top = `${stickerData.position.y}px`;
                            sticker.style.width = `${stickerData.size.width}px`;
                            sticker.style.height = `${stickerData.size.height}px`;
                            sticker.style.fontSize = `${stickerData.size.height * 0.8}px`;
                            
                            visionboardCanvas.appendChild(sticker);
                            setupStickerEvents(sticker, stickerData);
                        });
                    }
                    
                    // æ›´æ–°èƒŒæ™¯
                    updateCanvasBackground();
                    
                    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ„¿æœ›
                    if (visionBoard.wishes.length > 0) {
                        selectWish(visionBoard.wishes[0].id);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ„¿æœ›ï¼Œæ˜¾ç¤ºæç¤ºå¹¶è·³è½¬å›æ„¿æœ›ç¢ç‰‡é¡µé¢
                    showNotification('è¯·å…ˆå®Œæˆæ„¿æœ›ç¢ç‰‡è®¾å®š', 'info');
                    setTimeout(() => {
                        window.location.href = `dreamfragment.html?year=${visionBoard.currentYear}`;
                    }, 2000);
                }
            } catch (e) {
                console.error('åŠ è½½æ„¿æœ›ç¢ç‰‡å¤±è´¥:', e);
                showNotification('åŠ è½½æ„¿æœ›ç¢ç‰‡å¤±è´¥ï¼Œè¯·é‡æ–°å¼€å§‹', 'error');
            }
        }

        function createSampleWishes() {
            const sampleWishes = [
                "å¥åº·æœ‰æ´»åŠ›çš„èº«ä½“",
                "æŒæ¡ä¸€é—¨æ–°æŠ€èƒ½",
                "å®Œæˆä¸€æ¬¡æ·±åº¦æ—…è¡Œ",
                "æ”¹å–„è´¢åŠ¡çŠ¶å†µ",
                "å»ºç«‹æ·±åº¦å…³ç³»"
            ];
            
            visionBoard.wishes = sampleWishes.map((text, index) => ({
                id: index + 1,
                text: text,
                createdAt: new Date().toISOString(),
                image: null,
                frameType: '1',
                position: {
                    x: 50 + (index % 3) * 300,
                    y: 50 + Math.floor(index / 3) * 250
                },
                size: {
                    width: 250,
                    height: 300
                },
                rotation: 0,
                zIndex: index + 1
            }));
            
            updateWishCount();
            renderWishesList();
            createWishItemsOnCanvas();
            
            if (visionBoard.wishes.length > 0) {
                selectWish(visionBoard.wishes[0].id);
            }
        }

        function renderWishesList() {
            wishesList.innerHTML = '';
            
            visionBoard.wishes.forEach(wish => {
                const listItem = document.createElement('div');
                listItem.className = 'wish-list-item';
                if (wish.id === visionBoard.selectedWishId) {
                    listItem.classList.add('active');
                }
                listItem.dataset.wishId = wish.id;
                
                listItem.innerHTML = `
                    <div class="wish-number">${wish.id}</div>
                    <div class="wish-text">${wish.text || 'æœªå‘½åæ„¿æœ›'}</div>
                    <div class="wish-status ${wish.image ? 'has-image' : ''}" data-wish-id="${wish.id}" title="${wish.image ? 'å·²ä¸Šä¼ å›¾ç‰‡' : 'ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡'}">
                        <i class="fas ${wish.image ? 'fa-check' : 'fa-image'}"></i>
                    </div>
                `;
                
                listItem.addEventListener('click', function(e) {
                    if (!e.target.closest('.wish-status')) {
                        selectWish(wish.id);
                    }
                });
                
                const statusBtn = listItem.querySelector('.wish-status');
                statusBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectWish(wish.id);
                    imageUploadInput.click();
                });
                
                wishesList.appendChild(listItem);
            });
        }

        function createWishItemsOnCanvas() {
            visionBoard.wishes.forEach(wish => {
                createWishItemElement(wish);
            });
        }

        function createWishItemElement(wish) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingItem = document.querySelector(`.wish-item-container[data-wish-id="${wish.id}"]`);
            if (existingItem) {
                existingItem.remove();
            }
            
            // åˆ›å»ºå®¹å™¨
            const container = document.createElement('div');
            container.className = 'wish-item-container';
            container.dataset.wishId = wish.id;
            container.style.left = `${wish.position.x}px`;
            container.style.top = `${wish.position.y}px`;
            container.style.width = `${wish.size.width}px`;
            container.style.height = `${wish.size.height}px`;
            container.style.transform = `rotate(${wish.rotation}deg)`;
            container.style.zIndex = wish.zIndex;
            
            // åˆ›å»ºæ„¿æœ›é¡¹ç›®
            const wishItem = document.createElement('div');
            wishItem.className = 'wish-item';
            
            // å›¾ç‰‡åŒºåŸŸ
            const imageDiv = document.createElement('div');
            imageDiv.className = 'wish-image';
            
            if (wish.image) {
                imageDiv.style.backgroundImage = `url(${wish.image})`;
                imageDiv.style.backgroundSize = 'cover';
                imageDiv.style.backgroundPosition = 'center';
            } else {
                imageDiv.classList.add('placeholder');
                imageDiv.innerHTML = `<i class="fas fa-image"></i>`;
            }
            
            // æ–‡å­—åŒºåŸŸ
            const textDiv = document.createElement('div');
            textDiv.className = 'wish-text';
            textDiv.textContent = wish.text || 'æ„¿æœ›ç¢ç‰‡';
            
            // ç›¸æ¡†
            const frameDiv = document.createElement('div');
            frameDiv.className = `wish-frame type-${wish.frameType || '1'}`;
            
            // æ§åˆ¶æŒ‰é’®
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'wish-controls';
            controlsDiv.innerHTML = `
                <div class="wish-control-btn delete" title="åˆ é™¤">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <div class="wish-control-btn resize" title="è°ƒæ•´å¤§å°">
                    <i class="fas fa-expand-alt"></i>
                </div>
                <div class="wish-control-btn rotate" title="æ—‹è½¬">
                    <i class="fas fa-redo-alt"></i>
                </div>
            `;
            
            // ç»„è£…
            wishItem.appendChild(imageDiv);
            wishItem.appendChild(textDiv);
            container.appendChild(wishItem);
            container.appendChild(frameDiv);
            container.appendChild(controlsDiv);
            
            // æ·»åŠ åˆ°ç”»å¸ƒ
            visionboardCanvas.appendChild(container);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupWishItemEvents(container, wish);
            
            return container;
        }

        function setupWishItemEvents(container, wish) {
            // é€‰ä¸­æ„¿æœ›
            container.addEventListener('click', function(e) {
                if (!e.target.closest('.wish-control-btn')) {
                    selectWish(wish.id);
                }
            });
            
            // åˆ é™¤æŒ‰é’®
            const deleteBtn = container.querySelector('.wish-control-btn.delete');
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                if (confirm('ç¡®å®šè¦ä»æ„¿æ™¯æ¿ä¸­ç§»é™¤è¿™ä¸ªæ„¿æœ›å—ï¼Ÿ')) {
                    removeWishFromBoard(wish.id);
                }
            });
            
            // è°ƒæ•´å¤§å°æŒ‰é’®
            const resizeBtn = container.querySelector('.wish-control-btn.resize');
            resizeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                // éšæœºè°ƒæ•´å¤§å°
                const newWidth = Math.max(180, Math.min(400, wish.size.width + (Math.random() > 0.5 ? 30 : -30)));
                const newHeight = Math.max(240, Math.min(500, wish.size.height + (Math.random() > 0.5 ? 40 : -40)));
                
                updateWishSize(wish.id, newWidth, newHeight);
            });
            
            // æ—‹è½¬æŒ‰é’®
            const rotateBtn = container.querySelector('.wish-control-btn.rotate');
            rotateBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const newRotation = (wish.rotation + 15) % 360;
                updateWishRotation(wish.id, newRotation);
            });
            
            // æ‹–æ‹½ç§»åŠ¨
            let isDragging = false;
            let dragStartX, dragStartY, itemStartX, itemStartY;
            
            container.addEventListener('mousedown', function(e) {
                if (e.target.closest('.wish-control-btn')) {
                    return;
                }
                
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                itemStartX = parseInt(container.style.left);
                itemStartY = parseInt(container.style.top);
                
                // é€‰ä¸­è¿™ä¸ªæ„¿æœ›
                selectWish(wish.id);
                
                // æé«˜å±‚çº§
                visionBoard.wishes.forEach(w => {
                    if (w.id === wish.id) {
                        w.zIndex = 1000;
                    } else if (w.zIndex > 900) {
                        w.zIndex -= 1;
                    }
                });
                container.style.zIndex = 1000;
                
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', stopDrag);
            });
            
            function handleDrag(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                const newX = Math.max(0, Math.min(visionBoard.canvasWidth - parseInt(container.style.width), itemStartX + deltaX));
                const newY = Math.max(0, Math.min(visionBoard.canvasHeight - parseInt(container.style.height), itemStartY + deltaY));
                
                container.style.left = `${newX}px`;
                container.style.top = `${newY}px`;
            }
            
            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', handleDrag);
                document.removeEventListener('mouseup', stopDrag);
                
                // æ›´æ–°æ„¿æœ›ä½ç½®
                const newX = parseInt(container.style.left);
                const newY = parseInt(container.style.top);
                updateWishPosition(wish.id, newX, newY);
            }
        }

        function createDecorationsGrid() {
            decorationsGrid.innerHTML = '';
            
            visionBoard.decorations.forEach(decoration => {
                const decorationItem = document.createElement('div');
                decorationItem.className = 'decoration-item';
                decorationItem.dataset.decorationId = decoration.id;
                decorationItem.title = 'ç‚¹å‡»æ·»åŠ åˆ°æ„¿æ™¯æ¿';
                decorationItem.innerHTML = `<i class="${decoration.icon}"></i>`;
                
                decorationItem.addEventListener('click', function() {
                    addStickerToCanvas(decoration);
                });
                
                decorationsGrid.appendChild(decorationItem);
            });
        }

        function addStickerToCanvas(decoration) {
            // åˆ›å»ºè´´çº¸å…ƒç´ 
            const sticker = document.createElement('div');
            sticker.className = 'sticker-element';
            sticker.innerHTML = `<div style="text-align: center;">${decoration.content}</div>`;
            
            // éšæœºä½ç½®å’Œå¤§å°
            const x = Math.random() * (visionBoard.canvasWidth - 80);
            const y = Math.random() * (visionBoard.canvasHeight - 80);
            const size = 60 + Math.random() * 40;
            
            sticker.style.left = `${x}px`;
            sticker.style.top = `${y}px`;
            sticker.style.width = `${size}px`;
            sticker.style.height = `${size}px`;
            sticker.style.fontSize = `${size * 0.8}px`;
            
            // æ·»åŠ åˆ°ç”»å¸ƒ
            visionboardCanvas.appendChild(sticker);
            
            // æ·»åŠ åˆ°æ•°æ®
            const stickerData = {
                id: Date.now(),
                type: 'sticker',
                content: decoration.content,
                position: { x, y },
                size: { width: size, height: size }
            };
            
            visionBoard.stickers.push(stickerData);
            
            // è®¾ç½®è´´çº¸äº‹ä»¶
            setupStickerEvents(sticker, stickerData);
            
            showNotification(`å·²æ·»åŠ  ${decoration.content} è´´çº¸`, 'success');
        }

        function setupStickerEvents(sticker, stickerData) {
            // æ‹–æ‹½ç§»åŠ¨
            let isDragging = false;
            let dragStartX, dragStartY, stickerStartX, stickerStartY;
            
            sticker.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                stickerStartX = parseInt(sticker.style.left);
                stickerStartY = parseInt(sticker.style.top);
                
                document.addEventListener('mousemove', handleStickerDrag);
                document.addEventListener('mouseup', stopStickerDrag);
            });
            
            function handleStickerDrag(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;
                
                const newX = Math.max(0, Math.min(visionBoard.canvasWidth - parseInt(sticker.style.width), stickerStartX + deltaX));
                const newY = Math.max(0, Math.min(visionBoard.canvasHeight - parseInt(sticker.style.height), stickerStartY + deltaY));
                
                sticker.style.left = `${newX}px`;
                sticker.style.top = `${newY}px`;
            }
            
            function stopStickerDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', handleStickerDrag);
                document.removeEventListener('mouseup', stopStickerDrag);
                
                // æ›´æ–°è´´çº¸ä½ç½®
                const newX = parseInt(sticker.style.left);
                const newY = parseInt(sticker.style.top);
                
                const stickerIndex = visionBoard.stickers.findIndex(s => s.id === stickerData.id);
                if (stickerIndex !== -1) {
                    visionBoard.stickers[stickerIndex].position = { x: newX, y: newY };
                    saveVisionBoardState();
                }
            }
            
            // åŒå‡»åˆ é™¤
            sticker.addEventListener('dblclick', function() {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´´çº¸å—ï¼Ÿ')) {
                    sticker.remove();
                    
                    // ä»æ•°æ®ä¸­ç§»é™¤
                    const stickerIndex = visionBoard.stickers.findIndex(s => s.id === stickerData.id);
                    if (stickerIndex !== -1) {
                        visionBoard.stickers.splice(stickerIndex, 1);
                        saveVisionBoardState();
                    }
                }
            });
        }

        function selectWish(wishId) {
            // æ›´æ–°é€‰ä¸­çš„æ„¿æœ›ID
            visionBoard.selectedWishId = wishId;
            
            // æ›´æ–°UI
            document.querySelectorAll('.wish-item-container').forEach(container => {
                container.classList.remove('selected');
            });
            
            document.querySelectorAll('.wish-list-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // é€‰ä¸­å¯¹åº”çš„æ„¿æœ›
            const wishContainer = document.querySelector(`.wish-item-container[data-wish-id="${wishId}"]`);
            const listItem = document.querySelector(`.wish-list-item[data-wish-id="${wishId}"]`);
            
            if (wishContainer) {
                wishContainer.classList.add('selected');
            }
            
            if (listItem) {
                listItem.classList.add('active');
            }
            
            // æ›´æ–°å±æ€§é¢æ¿
            updatePropertiesPanel();
            
            // æ›´æ–°é€‰ä¸­ä¿¡æ¯
            const wish = visionBoard.wishes.find(w => w.id === wishId);
            if (wish) {
                selectionInfo.textContent = `é€‰ä¸­: "${wish.text}"`;
            }
        }

        function updateWishCount() {
            const count = visionBoard.wishes.length;
            wishCount.textContent = `${count}/12`;
            
            // æ›´æ–°ä¸‹ä¸€æ­¥æŒ‰é’®çŠ¶æ€
            const hasWishes = visionBoard.wishes.length > 0;
            completeBtn.disabled = !hasWishes;
            
            if (!hasWishes) {
                completeBtn.style.opacity = '0.6';
                completeBtn.style.cursor = 'not-allowed';
            } else {
                completeBtn.style.opacity = '1';
                completeBtn.style.cursor = 'pointer';
            }
        }

        function updateWishPosition(wishId, x, y) {
            const wishIndex = visionBoard.wishes.findIndex(w => w.id === wishId);
            if (wishIndex !== -1) {
                visionBoard.wishes[wishIndex].position = { x, y };
                saveVisionBoardState();
            }
        }

        function updateWishSize(wishId, width, height) {
            const wishIndex = visionBoard.wishes.findIndex(w => w.id === wishId);
            if (wishIndex !== -1) {
                visionBoard.wishes[wishIndex].size = { width, height };
                
                // æ›´æ–°UI
                const container = document.querySelector(`.wish-item-container[data-wish-id="${wishId}"]`);
                if (container) {
                    container.style.width = `${width}px`;
                    container.style.height = `${height}px`;
                }
                
                saveVisionBoardState();
            }
        }

        function updateWishRotation(wishId, rotation) {
            const wishIndex = visionBoard.wishes.findIndex(w => w.id === wishId);
            if (wishIndex !== -1) {
                visionBoard.wishes[wishIndex].rotation = rotation;
                
                // æ›´æ–°UI
                const container = document.querySelector(`.wish-item-container[data-wish-id="${wishId}"]`);
                if (container) {
                    container.style.transform = `rotate(${rotation}deg)`;
                }
                
                saveVisionBoardState();
            }
        }

        function updateWishImage(wishId, imageData) {
            const wishIndex = visionBoard.wishes.findIndex(w => w.id === wishId);
            if (wishIndex !== -1) {
                visionBoard.wishes[wishIndex].image = imageData;
                
                // æ›´æ–°UI
                const container = document.querySelector(`.wish-item-container[data-wish-id="${wishId}"]`);
                if (container) {
                    const imageDiv = container.querySelector('.wish-image');
                    if (imageDiv) {
                        imageDiv.style.backgroundImage = `url(${imageData})`;
                        imageDiv.style.backgroundSize = 'cover';
                        imageDiv.style.backgroundPosition = 'center';
                        imageDiv.classList.remove('placeholder');
                    }
                }
                
                // æ›´æ–°åˆ—è¡¨ä¸­çš„çŠ¶æ€å›¾æ ‡
                const listItem = document.querySelector(`.wish-list-item[data-wish-id="${wishId}"] .wish-status`);
                if (listItem) {
                    listItem.classList.add('has-image');
                    listItem.innerHTML = '<i class="fas fa-check"></i>';
                    listItem.title = 'å·²ä¸Šä¼ å›¾ç‰‡';
                }
                
                saveVisionBoardState();
                showNotification('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼', 'success');
            }
        }

        function updateWishFrame(wishId, frameType) {
            const wishIndex = visionBoard.wishes.findIndex(w => w.id === wishId);
            if (wishIndex !== -1) {
                visionBoard.wishes[wishIndex].frameType = frameType;
                
                // æ›´æ–°UI
                const container = document.querySelector(`.wish-item-container[data-wish-id="${wishId}"]`);
                if (container) {
                    const frameDiv = container.querySelector('.wish-frame');
                    if (frameDiv) {
                        frameDiv.className = `wish-frame type-${frameType}`;
                    }
                }
                
                saveVisionBoardState();
            }
        }

        function removeWishFromBoard(wishId) {
            // ä»ç”»å¸ƒä¸­ç§»é™¤
            const container = document.querySelector(`.wish-item-container[data-wish-id="${wishId}"]`);
            if (container) {
                container.remove();
            }
            
            // ä»æ•°æ®ä¸­ç§»é™¤
            const wishIndex = visionBoard.wishes.findIndex(w => w.id === wishId);
            if (wishIndex !== -1) {
                visionBoard.wishes.splice(wishIndex, 1);
                
                // æ›´æ–°åˆ—è¡¨
                renderWishesList();
                updateWishCount();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯é€‰ä¸­çš„æ„¿æœ›ï¼Œé€‰ä¸­å¦ä¸€ä¸ª
                if (visionBoard.selectedWishId === wishId) {
                    if (visionBoard.wishes.length > 0) {
                        selectWish(visionBoard.wishes[0].id);
                    } else {
                        visionBoard.selectedWishId = null;
                        selectionInfo.textContent = 'æœªé€‰ä¸­ä»»ä½•å…ƒç´ ';
                        updatePropertiesPanel();
                    }
                }
                
                saveVisionBoardState();
                showNotification('æ„¿æœ›å·²ä»æ„¿æ™¯æ¿ä¸­ç§»é™¤', 'info');
            }
        }

        function updateCanvasBackground() {
            const bgType = visionBoard.selectedBackgroundType;
            
            switch(bgType) {
                case '1':
                    boardBackground.style.backgroundColor = '#FFF9F0';
                    boardBackground.style.backgroundImage = 'none';
                    break;
                case '2':
                    boardBackground.style.background = 'linear-gradient(135deg, #FFEEDD, #FFF9F0)';
                    break;
                case '3':
                    boardBackground.style.backgroundColor = '#FFF9F0';
                    boardBackground.style.backgroundImage = 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="%23FFB6C1" opacity="0.2"/></svg>\')';
                    break;
                case '4':
                    boardBackground.style.backgroundColor = '#FFF9F0';
                    boardBackground.style.backgroundImage = 'url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="0.5" fill="%234ECDC4" opacity="0.1"/></svg>\')';
                    break;
                default:
                    boardBackground.style.backgroundColor = '#FFF9F0';
            }
        }

        function updatePropertiesPanel() {
            // æ ¹æ®å½“å‰é€‰æ‹©æ˜¾ç¤ºä¸åŒçš„å±æ€§é¢æ¿
            if (visionBoard.selectedWishId) {
                propertiesImage.classList.add('active');
                propertiesBackground.classList.remove('active');
                
                // æ›´æ–°é€‰ä¸­çš„ç›¸æ¡†
                const wish = visionBoard.wishes.find(w => w.id === visionBoard.selectedWishId);
                if (wish) {
                    document.querySelectorAll('.frame-option').forEach(option => {
                        option.classList.remove('active');
                    });
                    
                    const selectedFrame = document.querySelector(`.frame-option[data-frame="${wish.frameType || '1'}"]`);
                    if (selectedFrame) {
                        selectedFrame.classList.add('active');
                    }
                }
            } else {
                propertiesImage.classList.remove('active');
                propertiesBackground.classList.add('active');
                
                // æ›´æ–°é€‰ä¸­çš„èƒŒæ™¯
                document.querySelectorAll('.bg-option').forEach(option => {
                    option.classList.remove('active');
                });
                
                const selectedBg = document.querySelector(`.bg-option[data-bg="${visionBoard.selectedBackgroundType}"]`);
                if (selectedBg) {
                    selectedBg.classList.add('active');
                }
            }
        }

        function saveVisionBoardState() {
            try {
                const boardState = {
                    wishes: visionBoard.wishes,
                    stickers: visionBoard.stickers,
                    backgroundType: visionBoard.selectedBackgroundType,
                    lastUpdated: new Date().toISOString()
                };
                
                // ä½¿ç”¨å¹´ä»½ç›¸å…³çš„keyä¿å­˜
                const boardStateKey = `visionboard_${visionBoard.currentYear}`;
                setStorageData(boardStateKey, boardState);
                return true;
            } catch (e) {
                console.error('ä¿å­˜æ„¿æ™¯æ¿çŠ¶æ€å¤±è´¥:', e);
                return false;
            }
        }

        function loadVisionBoardState() {
            try {
                // ä½¿ç”¨å¹´ä»½ç›¸å…³çš„keyåŠ è½½
                const boardStateKey = `visionboard_${visionBoard.currentYear}`;
                const savedState = getStorageData(boardStateKey);
                
                if (savedState) {
                    visionBoard.wishes = savedState.wishes || [];
                    visionBoard.stickers = savedState.stickers || [];
                    visionBoard.selectedBackgroundType = savedState.backgroundType || '1';
                    
                    // æ›´æ–°UI
                    renderWishesList();
                    updateWishCount();
                    updateCanvasBackground();
                    
                    // é‡æ–°åˆ›å»ºç”»å¸ƒä¸Šçš„å…ƒç´ 
                    document.querySelectorAll('.wish-item-container, .sticker-element').forEach(el => el.remove());
                    createWishItemsOnCanvas();
                    
                    // åˆ›å»ºè´´çº¸
                    if (savedState.stickers && savedState.stickers.length > 0) {
                        savedState.stickers.forEach(stickerData => {
                            const sticker = document.createElement('div');
                            sticker.className = 'sticker-element';
                            sticker.innerHTML = `<div style="text-align: center;">${stickerData.content}</div>`;
                            
                            sticker.style.left = `${stickerData.position.x}px`;
                            sticker.style.top = `${stickerData.position.y}px`;
                            sticker.style.width = `${stickerData.size.width}px`;
                            sticker.style.height = `${stickerData.size.height}px`;
                            sticker.style.fontSize = `${stickerData.size.height * 0.8}px`;
                            
                            visionboardCanvas.appendChild(sticker);
                            setupStickerEvents(sticker, stickerData);
                        });
                    }
                    
                    updatePropertiesPanel();
                    showNotification('å·²åŠ è½½ä¿å­˜çš„æ„¿æ™¯æ¿', 'success');
                }
            } catch (e) {
                console.error('åŠ è½½æ„¿æ™¯æ¿çŠ¶æ€å¤±è´¥:', e);
            }
        }

        function setupEventListeners() {
            // å·¥å…·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            Object.entries(toolButtons).forEach(([tool, button]) => {
                button.addEventListener('click', function() {
                    // æ›´æ–°å·¥å…·æŒ‰é’®çŠ¶æ€
                    Object.values(toolButtons).forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // æ›´æ–°å½“å‰å·¥å…·
                    visionBoard.selectedTool = tool;
                    
                    // æ ¹æ®å·¥å…·æ›´æ–°å±æ€§é¢æ¿
                    updatePropertiesPanel();
                    
                    // æ˜¾ç¤ºå·¥å…·æç¤º
                    const toolNames = {
                        select: 'é€‰æ‹©',
                        move: 'ç§»åŠ¨',
                        sticker: 'è´´çº¸',
                        frame: 'ç›¸æ¡†',
                        text: 'æ–‡å­—',
                        delete: 'åˆ é™¤'
                    };
                    
                    showNotification(`å·²åˆ‡æ¢åˆ°${toolNames[tool]}å·¥å…·`, 'info');
                });
            });
            
            // å›¾ç‰‡ä¸Šä¼ 
            uploadImageBtn.addEventListener('click', function() {
                if (visionBoard.selectedWishId) {
                    imageUploadInput.click();
                } else {
                    showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ„¿æœ›', 'info');
                }
            });
            
            imageUploadInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å°
                    if (file.size > 2 * 1024 * 1024) {
                        showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB', 'error');
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.type.match('image.*')) {
                        showNotification('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        if (visionBoard.selectedWishId) {
                            updateWishImage(visionBoard.selectedWishId, event.target.result);
                        }
                    };
                    reader.readAsDataURL(file);
                    
                    // é‡ç½®æ–‡ä»¶è¾“å…¥
                    imageUploadInput.value = '';
                }
            });
            
            // ç›¸æ¡†é€‰æ‹©
            document.querySelectorAll('.frame-option').forEach(option => {
                option.addEventListener('click', function() {
                    const frameType = this.dataset.frame;
                    
                    // æ›´æ–°UI
                    document.querySelectorAll('.frame-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // æ›´æ–°é€‰ä¸­çš„æ„¿æœ›çš„ç›¸æ¡†
                    if (visionBoard.selectedWishId) {
                        updateWishFrame(visionBoard.selectedWishId, frameType);
                    }
                });
            });
            
            // èƒŒæ™¯é€‰æ‹©
            document.querySelectorAll('.bg-option').forEach(option => {
                option.addEventListener('click', function() {
                    const bgType = this.dataset.bg;
                    
                    // æ›´æ–°UI
                    document.querySelectorAll('.bg-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // æ›´æ–°èƒŒæ™¯
                    visionBoard.selectedBackgroundType = bgType;
                    updateCanvasBackground();
                    saveVisionBoardState();
                });
            });
            
            // æ¸…ç©ºè£…é¥°æŒ‰é’®
            document.getElementById('clearDecorationsBtn').addEventListener('click', function() {
                if (visionBoard.stickers.length > 0) {
                    if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è£…é¥°å…ƒç´ å—ï¼Ÿå…±${visionBoard.stickers.length}ä¸ª`)) {
                        // ç§»é™¤æ‰€æœ‰è´´çº¸
                        document.querySelectorAll('.sticker-element').forEach(el => el.remove());
                        
                        // æ¸…ç©ºæ•°æ®
                        visionBoard.stickers = [];
                        saveVisionBoardState();
                        
                        showNotification('å·²æ¸…ç©ºæ‰€æœ‰è£…é¥°å…ƒç´ ', 'info');
                    }
                } else {
                    showNotification('å½“å‰æ²¡æœ‰è£…é¥°å…ƒç´ ', 'info');
                }
            });
            
            // ç¼©æ”¾æŒ‰é’®
            document.getElementById('zoomInBtn').addEventListener('click', function() {
                if (visionBoard.canvasScale < 2) {
                    visionBoard.canvasScale += 0.1;
                    visionboardCanvas.style.transform = `scale(${visionBoard.canvasScale})`;
                    visionboardCanvas.style.transformOrigin = 'center';
                }
            });
            
            document.getElementById('zoomOutBtn').addEventListener('click', function() {
                if (visionBoard.canvasScale > 0.5) {
                    visionBoard.canvasScale -= 0.1;
                    visionboardCanvas.style.transform = `scale(${visionBoard.canvasScale})`;
                    visionboardCanvas.style.transformOrigin = 'center';
                }
            });
            
            // ä¿å­˜å›¾ç‰‡æŒ‰é’®
            document.getElementById('saveImageBtn').addEventListener('click', function() {
                saveVisionBoardAsImage();
            });
            
            // è¿”å›æŒ‰é’®
            backBtn.addEventListener('click', function() {
                if (confirm('è¿”å›ä¸Šä¸€æ­¥ä¼šä¿å­˜å½“å‰æ„¿æ™¯æ¿ï¼Œç¡®å®šè¦è¿”å›å—ï¼Ÿ')) {
                    saveVisionBoardState();
                    showNotification('æ„¿æ™¯æ¿å·²ä¿å­˜ï¼Œè¿”å›ä¸Šä¸€æ­¥...', 'info');
                    setTimeout(() => {
                        window.location.href = `dreamfragment.html?year=${visionBoard.currentYear}`;
                    }, 1000);
                }
            });
            
            // ä¿å­˜è‰ç¨¿æŒ‰é’®
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                if (saveVisionBoardState()) {
                    showNotification('æ„¿æ™¯æ¿è‰ç¨¿å·²ä¿å­˜', 'success');
                } else {
                    showNotification('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            });
            
            // åŠ è½½è‰ç¨¿æŒ‰é’®
            document.getElementById('loadDraftBtn').addEventListener('click', function() {
                if (confirm('åŠ è½½è‰ç¨¿ä¼šæ›¿æ¢å½“å‰å†…å®¹ï¼Œç¡®å®šè¦åŠ è½½å—ï¼Ÿ')) {
                    // é‡æ–°åŠ è½½æ„¿æœ›æ•°æ®
                    loadWishesFromStorage();
                    // åŠ è½½ä¿å­˜çš„æ„¿æ™¯æ¿çŠ¶æ€
                    loadVisionBoardState();
                }
            });
            
            // å®ŒæˆæŒ‰é’®
            completeBtn.addEventListener('click', function() {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ„¿æœ›
                if (visionBoard.wishes.length === 0) {
                    showNotification('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªæ„¿æœ›åˆ°æ„¿æ™¯æ¿', 'error');
                    return;
                }
                
                // ä¿å­˜æ„¿æ™¯æ¿
                saveVisionBoardState();
                
                // æ›´æ–°æ˜ŸçƒçŠ¶æ€
                updatePlanet(visionBoard.currentYear, {
                    visionBoardCompleted: true,
                    visionBoardCompletedAt: new Date().toISOString(),
                    visionBoard: {
                        wishes: visionBoard.wishes,
                        stickers: visionBoard.stickers,
                        backgroundType: visionBoard.selectedBackgroundType
                    }
                });
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                completeBtn.disabled = true;
                completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...';
                
                // å¤„ç†è¿‡ç¨‹
                setTimeout(() => {
                    showNotification('ğŸ‰ æ„¿æ™¯æ¿åˆ¶ä½œå®Œæˆï¼å³å°†è¿›å…¥ä¸“æ³¨æ—¶å…‰è®°å½•...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = `hoursputin.html?year=${visionBoard.currentYear}`;
                    }, 1500);
                }, 1500);
            });
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S ä¿å­˜
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (saveVisionBoardState()) {
                        showNotification('æ„¿æ™¯æ¿å·²ä¿å­˜', 'success');
                    }
                }
                
                // Delete é”®åˆ é™¤é€‰ä¸­é¡¹
                if (e.key === 'Delete' && visionBoard.selectedWishId) {
                    removeWishFromBoard(visionBoard.selectedWishId);
                }
                
                // æ–¹å‘é”®ç§»åŠ¨é€‰ä¸­é¡¹
                if (visionBoard.selectedWishId) {
                    const selectedContainer = document.querySelector(`.wish-item-container[data-wish-id="${visionBoard.selectedWishId}"]`);
                    if (selectedContainer) {
                        const step = 10;
                        let deltaX = 0, deltaY = 0;
                        
                        switch(e.key) {
                            case 'ArrowLeft':
                                deltaX = -step;
                                break;
                            case 'ArrowRight':
                                deltaX = step;
                                break;
                            case 'ArrowUp':
                                deltaY = -step;
                                break;
                            case 'ArrowDown':
                                deltaY = step;
                                break;
                        }
                        
                        if (deltaX !== 0 || deltaY !== 0) {
                            e.preventDefault();
                            
                            const currentX = parseInt(selectedContainer.style.left);
                            const currentY = parseInt(selectedContainer.style.top);
                            const width = parseInt(selectedContainer.style.width);
                            const height = parseInt(selectedContainer.style.height);
                            
                            const newX = Math.max(0, Math.min(visionBoard.canvasWidth - width, currentX + deltaX));
                            const newY = Math.max(0, Math.min(visionBoard.canvasHeight - height, currentY + deltaY));
                            
                            selectedContainer.style.left = `${newX}px`;
                            selectedContainer.style.top = `${newY}px`;
                            
                            updateWishPosition(visionBoard.selectedWishId, newX, newY);
                        }
                    }
                }
            });
        }

        function saveVisionBoardAsImage() {
            showNotification('æ­£åœ¨ç”Ÿæˆé«˜æ¸…å›¾ç‰‡...', 'info');
            
            // æ£€æŸ¥html2canvasæ˜¯å¦å·²åŠ è½½
            if (typeof html2canvas === 'undefined') {
                showNotification('å›¾ç‰‡ç”Ÿæˆåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            // è·å–æ„¿æ™¯æ¿ç”»å¸ƒå…ƒç´ 
            const canvasElement = document.getElementById('visionboardCanvas');
            if (!canvasElement) {
                showNotification('æœªæ‰¾åˆ°æ„¿æ™¯æ¿ç”»å¸ƒ', 'error');
                return;
            }
            
            // ä¸´æ—¶éšè—æ§åˆ¶æŒ‰é’®å’Œé€‰ä¸­çŠ¶æ€ï¼Œç¡®ä¿å›¾ç‰‡å¹²å‡€
            const allControls = document.querySelectorAll('.wish-controls');
            const selectedItems = document.querySelectorAll('.wish-item-container.selected');
            const originalDisplay = [];
            const originalSelected = [];
            
            allControls.forEach((control, index) => {
                originalDisplay[index] = control.style.display;
                control.style.display = 'none';
            });
            
            selectedItems.forEach((item, index) => {
                originalSelected[index] = item.classList.contains('selected');
                item.classList.remove('selected');
            });
            
            // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
            const images = canvasElement.querySelectorAll('img, [style*="background-image"]');
            let loadedCount = 0;
            const totalImages = images.length;
            
            function checkAllImagesLoaded() {
                loadedCount++;
                if (loadedCount >= totalImages) {
                    generateImage();
                }
            }
            
            if (totalImages === 0) {
                // æ²¡æœ‰å›¾ç‰‡ï¼Œç›´æ¥ç”Ÿæˆ
                generateImage();
            } else {
                // ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½
                images.forEach(img => {
                    if (img.tagName === 'IMG') {
                        if (img.complete) {
                            checkAllImagesLoaded();
                        } else {
                            img.onload = checkAllImagesLoaded;
                            img.onerror = checkAllImagesLoaded; // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿç»§ç»­
                        }
                    } else {
                        // å¯¹äºèƒŒæ™¯å›¾ç‰‡ï¼Œå°è¯•é¢„åŠ è½½
                        const bgImage = window.getComputedStyle(img).backgroundImage;
                        if (bgImage && bgImage !== 'none') {
                            const urlMatch = bgImage.match(/url\(['"]?(.+?)['"]?\)/);
                            if (urlMatch) {
                                const imgUrl = urlMatch[1];
                                const testImg = new Image();
                                testImg.onload = checkAllImagesLoaded;
                                testImg.onerror = checkAllImagesLoaded;
                                testImg.src = imgUrl;
                            } else {
                                checkAllImagesLoaded();
                            }
                        } else {
                            checkAllImagesLoaded();
                        }
                    }
                });
            }
            
            function generateImage() {
                // ä½¿ç”¨html2canvasæ•è·ç”»å¸ƒ
                html2canvas(canvasElement, {
                    backgroundColor: '#FFF9F0', // ä½¿ç”¨èƒŒæ™¯è‰²
                    scale: 2, // æé«˜åˆ†è¾¨ç‡ï¼ˆ2å€ï¼‰
                    useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡
                    allowTaint: true, // å…è®¸è·¨åŸŸå›¾ç‰‡ï¼ˆå³ä½¿CORSå¤±è´¥ï¼‰
                    logging: false, // å…³é—­æ§åˆ¶å°æ—¥å¿—
                    width: canvasElement.offsetWidth,
                    height: canvasElement.offsetHeight,
                    windowWidth: canvasElement.scrollWidth,
                    windowHeight: canvasElement.scrollHeight,
                    onclone: function(clonedDoc) {
                        // ç¡®ä¿å…‹éš†çš„æ–‡æ¡£ä¸­æ‰€æœ‰å…ƒç´ éƒ½æ­£ç¡®æ˜¾ç¤º
                        const clonedCanvas = clonedDoc.getElementById('visionboardCanvas');
                        if (clonedCanvas) {
                            // ç¡®ä¿èƒŒæ™¯å¯è§ä¸”æ­£ç¡®æ˜¾ç¤º
                            const bg = clonedCanvas.querySelector('.board-background');
                            if (bg) {
                                bg.style.display = 'block';
                                bg.style.visibility = 'visible';
                                bg.style.opacity = '1';
                                bg.style.zIndex = '0';
                            }
                            
                            // ç¡®ä¿æ‰€æœ‰æ„¿æœ›é¡¹ç›®å¯è§
                            const wishItems = clonedCanvas.querySelectorAll('.wish-item-container');
                            wishItems.forEach(item => {
                                item.style.display = 'block';
                                item.style.visibility = 'visible';
                                item.style.opacity = '1';
                                
                                // ç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
                                const wishImage = item.querySelector('.wish-image');
                                if (wishImage) {
                                    const bgImage = wishImage.style.backgroundImage;
                                    if (bgImage && bgImage !== 'none') {
                                        wishImage.style.backgroundImage = bgImage;
                                        wishImage.style.backgroundSize = 'cover';
                                        wishImage.style.backgroundPosition = 'center';
                                    }
                                }
                                
                                // ç¡®ä¿ç›¸æ¡†æ˜¾ç¤º
                                const frame = item.querySelector('.wish-frame');
                                if (frame) {
                                    frame.style.display = 'block';
                                    frame.style.visibility = 'visible';
                                }
                                
                                // éšè—æ§åˆ¶æŒ‰é’®
                                const controls = item.querySelector('.wish-controls');
                                if (controls) {
                                    controls.style.display = 'none';
                                }
                            });
                            
                            // ç¡®ä¿æ‰€æœ‰è´´çº¸å¯è§
                            const stickers = clonedCanvas.querySelectorAll('.sticker-element');
                            stickers.forEach(sticker => {
                                sticker.style.display = 'block';
                                sticker.style.visibility = 'visible';
                                sticker.style.opacity = '1';
                            });
                            
                            // ç¡®ä¿æ–‡å­—å¯è§
                            const wishTexts = clonedCanvas.querySelectorAll('.wish-text');
                            wishTexts.forEach(text => {
                                text.style.color = '#5D4037'; // ç¡®ä¿æ–‡å­—é¢œè‰²æ­£ç¡®
                                text.style.visibility = 'visible';
                            });
                        }
                    }
                }).then(function(canvas) {
                    // æ¢å¤æ§åˆ¶æŒ‰é’®å’Œé€‰ä¸­çŠ¶æ€
                    allControls.forEach((control, index) => {
                        control.style.display = originalDisplay[index];
                    });
                    
                    selectedItems.forEach((item, index) => {
                        if (originalSelected[index]) {
                            item.classList.add('selected');
                        }
                    });
                    
                    // å°†canvasè½¬æ¢ä¸ºå›¾ç‰‡
                    canvas.toBlob(function(blob) {
                        if (!blob) {
                            showNotification('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                            return;
                        }
                        
                        // åˆ›å»ºä¸‹è½½é“¾æ¥
                        const url = URL.createObjectURL(blob);
                        const downloadLink = document.createElement('a');
                        downloadLink.href = url;
                        downloadLink.download = `æˆ‘çš„${visionBoard.currentYear}æ„¿æ™¯æ¿.png`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        // é‡Šæ”¾URLå¯¹è±¡
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                        }, 100);
                        
                        showNotification('ğŸ‰ é«˜æ¸…å›¾ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°', 'success');
                    }, 'image/png', 1.0); // æœ€é«˜è´¨é‡PNG
                    
                }).catch(function(error) {
                    // æ¢å¤æ§åˆ¶æŒ‰é’®å’Œé€‰ä¸­çŠ¶æ€
                    allControls.forEach((control, index) => {
                        control.style.display = originalDisplay[index];
                    });
                    
                    selectedItems.forEach((item, index) => {
                        if (originalSelected[index]) {
                            item.classList.add('selected');
                        }
                    });
                    
                    console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                    showNotification('å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                });
            }
        }

        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 25px;
                right: 25px;
                background-color: ${type === 'error' ? 'rgba(255, 107, 139, 0.95)' : type === 'success' ? 'rgba(78, 205, 196, 0.95)' : 'rgba(20, 20, 40, 0.95)'};
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 20px rgba(0,0,0,0.25);
                z-index: 10000;
                border-left: 5px solid ${type === 'error' ? '#FF6B8B' : type === 'success' ? '#4ECDC4' : '#FFD700'};
                animation: slideIn 0.4s ease, fadeOut 0.4s ease 2.5s forwards;
                max-width: 350px;
                font-family: 'Ma Shan Zheng', cursive;
                border: 1px solid ${type === 'error' ? 'rgba(255, 107, 139, 0.3)' : type === 'success' ? 'rgba(78, 205, 196, 0.3)' : 'rgba(255, 215, 0, 0.3)'};
                backdrop-filter: blur(10px);
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'}" 
                       style="font-size: 1.4rem; color: ${type === 'error' ? '#FF6B8B' : type === 'success' ? '#4ECDC4' : '#FFD700'};"></i>
                    <div style="color: white; font-size: 1.05rem; line-height: 1.4;">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ç§’åç§»é™¤é€šçŸ¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
            
            // æ·»åŠ CSSåŠ¨ç”»
            if (!document.getElementById('notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }
    </script>
</body>
</html>